<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="appTitle">Attendance Tracker Pro</title>
    
    <!-- Firebase SDKs (Compat Version for easy use) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        /* --- ‡§Ü‡§™‡§ï‡•Ä ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä CSS (Original Style) --- */
        :root {
            --background-color: #f4f4f4; --text-color: #333; --container-bg-color: #fff; --border-color: #ddd;
            --input-bg: #fff; --input-text: #333; --table-bg: #fff; --table-header-bg: #ddd;
            --primary-color: #007bff; --danger-color: #dc3545; --warning-color: #ffc107;
            --save-success-bg: #4CAF50;
        }
        html.dark {
            --background-color: #1a202c; --text-color: #a0aec0; --container-bg-color: #2d3748; --border-color: #4a5568;
            --input-bg: #2d3748; --input-text: #a0aec0;
        }
        body { font-family: Arial, sans-serif; padding: 20px; background-color: var(--background-color); color: var(--text-color); transition: 0.3s; }
        .container { display: flex; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; padding: 10px; background-color: var(--container-bg-color); border: 1px solid var(--border-color); border-radius: 5px; }
        input, select { padding: 6px; margin: 5px 0; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--input-text); }
        button { cursor: pointer; border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 4px; background: transparent; color: var(--text-color); }
        .table-responsive { overflow-x: auto; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: var(--table-bg); table-layout: fixed; }
        th, td { border: 1px solid var(--border-color); padding: 4px; text-align: center; }
        .hidden { display: none !important; }

        /* --- ‡§≤‡•â‡§ó‡§ø‡§® ‡§î‡§∞ ‡§ë‡§®‡§≤‡§æ‡§á‡§® UI --- */
        #authBox { max-width: 400px; margin: 50px auto; padding: 25px; background: white; border-radius: 12px; border: 1px solid #ddd; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        #authBox input { width: 100%; box-sizing: border-box; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; }
        #authBox button { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .nav-online { background: #343a40; color: white; padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .role-badge { background: #ffc107; color: black; padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; margin-left: 10px; }
        .invite-section { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #007bff; }
    </style>
</head>
<body>

    <!-- ‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® -->
    <div id="authBox">
        <h2 id="authTitle">Attendance Online Login</h2>
        <input type="email" id="email" placeholder="Email Address">
        <input type="password" id="password" placeholder="Password (Min 6 chars)">
        <button onclick="handleAuth('login')" style="background: #007bff; color: white;">Login (‡§≤‡•â‡§ó‡§ø‡§®)</button>
        <button id="signupBtn" onclick="handleAuth('signup')" style="background: #28a745; color: white;">Signup (‡§∏‡§ø‡§∞‡•ç‡§´ ‡§è‡§°‡§Æ‡§ø‡§® ‡§ï‡•á ‡§≤‡§ø‡§è)</button>
        <p id="inviteStatus" style="color: blue; font-weight: bold; margin-top: 15px;"></p>
    </div>

    <!-- ‡§Æ‡•á‡§® ‡§ê‡§™ -->
    <div id="appContainer" class="hidden">
        
        <!-- ‡§ü‡•â‡§™ ‡§¨‡§æ‡§∞ -->
        <div class="nav-online">
            <div>
                <i class="fas fa-user-circle"></i> <span id="userEmailDisplay"></span>
                <span id="userRoleDisplay" class="role-badge"></span>
            </div>
            <button onclick="logout()" style="color:white; border-color:white;">Logout</button>
        </div>

        <!-- ‡§á‡§®‡§µ‡§æ‡§á‡§ü ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡•á‡§ï‡•ç‡§∂‡§® (Admin/Super User ‡§ï‡•á ‡§≤‡§ø‡§è) -->
        <div id="inviteButtons" class="invite-section hidden">
            <p style="margin:0 0 10px 0;"><b>‡§ü‡•Ä‡§Æ ‡§ú‡•ã‡•ú‡•á‡§Ç (Invite Links):</b></p>
            <button onclick="generateInvite('super')" id="btnInviteSuper" style="background:#fb8c00; color:white; border:none;">Invite Super User (‡§†‡•á‡§ï‡•á‡§¶‡§æ‡§∞)</button>
            <button onclick="generateInvite('user')" style="background:#28a745; color:white; border:none; margin-left:10px;">Invite User (‡§Æ‡•Å‡§Ç‡§∂‡•Ä)</button>
        </div>

        <!-- ‡§ì‡§∞‡§ø‡§ú‡§ø‡§®‡§≤ ‡§ê‡§™ ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤‡•ç‡§∏ -->
        <div id="saveStatusIndicator" style="display:none;"></div>

        <div id="controlsHeader">
            <h1 id="appTitle" data-translate-key="appTitle">Attendance Tracker</h1>
            <div id="topControls">
                <button onclick="toggleLanguage()"><i class="fas fa-language"></i> <span id="currentLangDisplay">HI</span></button>
                <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
                <button onclick="toggleCalculationMode()">üìÖ</button>
                <button onclick="toggleDataMenu()"><i class="fas fa-database"></i></button>
            </div>
        </div>

        <div id="addUserInputContainer" class="container">
            <input type="text" id="newUserName" placeholder="‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§ú‡•ã‡•ú‡•á‡§Ç" style="flex-grow: 1;">
            <button onclick="addUser()" style="color:#28a745; border-color:#28a745;"><b>‚ûï</b></button>
        </div>

        <div id="userTabs" class="container"></div>

        <div id="userControl" class="hidden">
            <h2><span id="selectedUserName"></span></h2>
            
            <div id="userQuickControls" class="container">
                <div id="rateContainer">
                    <label>Rate:</label>
                    <input type="number" id="userRate">
                </div>
                <div id="manualBalanceContainer">
                    <label>Prev Balance:</label>
                    <input type="number" id="manualCarriedOverBalance">
                </div>
            </div>

            <div class="container" style="justify-content: space-between;">
                <button onclick="goToPreviousPeriod()">‚ùÆ Prev</button>
                <span id="currentMonthDisplay" style="font-weight:bold;"></span>
                <button onclick="goToNextPeriod()">Next ‚ùØ</button>
            </div>

            <button onclick="shareReport()" style="width:100%; background:var(--primary-color); color:white; padding:12px; margin-top:10px;">
                Share Report (Image)
            </button>
        </div>

        <div id="reportArea">
            <div id="tableContainer" class="table-responsive"></div>
            <div id="summarySection"></div>
        </div>

        <!-- ‡§°‡•á‡§ü‡§æ ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü (‡§∏‡§ø‡§∞‡•ç‡§´ ‡§è‡§°‡§Æ‡§ø‡§® ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ) -->
        <div id="dataManagementButtons" class="container hidden" style="background:#fff3cd;">
             <button onclick="clearAllData()" style="background:red; color:white;">DELETE ALL DATA</button>
        </div>
    </div>

<script>
    // --- ‡§Ü‡§™‡§ï‡•Ä ‡§®‡§à API ‡§µ‡§æ‡§≤‡•Ä ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® ---
    const firebaseConfig = {
        apiKey: "AIzaSyCFZL-_arIus7bnA4U9kKw0uhIet6Ng3SU",
        authDomain: "my-attendance-795fa.firebaseapp.com",
        projectId: "my-attendance-795fa",
        storageBucket: "my-attendance-795fa.firebasestorage.app",
        messagingSenderId: "462347673756",
        appId: "1:462347673756:web:bd69375de1db201b550d59",
        measurementId: "G-B03E17HG43"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let data = {};
    let currentUser = null;
    let calculationMode = 'fullMonth';
    let currentlyViewedPeriod = null;
    let userRole = 'admin';
    let masterAdminId = null;

    // --- ‡§≤‡•â‡§ó‡§ø‡§® ‡§î‡§∞ ‡§∞‡•ã‡§≤ ‡§≤‡•â‡§ú‡§ø‡§ï ---
    const params = new URLSearchParams(window.location.search);
    const inviteRole = params.get('role');
    const refId = params.get('ref');

    if(inviteRole) {
        document.getElementById('inviteStatus').innerText = "Joining as: " + inviteRole.toUpperCase();
        document.getElementById('signupBtn').innerText = "Register & Join";
    }

    async function handleAuth(type) {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try {
            if(type === 'signup') {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                const role = inviteRole || 'admin';
                const adminId = refId || res.user.uid;
                await db.collection("users").doc(res.user.uid).set({ email, role, adminId });
            } else {
                await auth.signInWithEmailAndPassword(email, pass);
            }
        } catch (e) { alert(e.message); }
    }

    auth.onAuthStateChanged(async (user) => {
        if(user) {
            const doc = await db.collection("users").doc(user.uid).get();
            const userData = doc.data();
            userRole = userData.role;
            masterAdminId = userData.adminId;

            document.getElementById('authBox').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('userEmailDisplay').innerText = user.email;
            document.getElementById('userRoleDisplay').innerText = userRole.toUpperCase();

            checkPermissions(userRole);
            syncOnlineData();
        } else {
            document.getElementById('authBox').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }
    });

    function checkPermissions(role) {
        if(role === 'admin') {
            document.getElementById('inviteButtons').classList.remove('hidden');
            document.getElementById('dataManagementButtons').classList.remove('hidden');
        } else if(role === 'super') {
            document.getElementById('inviteButtons').classList.remove('hidden');
            document.getElementById('btnInviteSuper').classList.add('hidden');
        } else {
            // ‡§Æ‡•Å‡§Ç‡§∂‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡•á‡§ü ‡§î‡§∞ ‡§ñ‡§∞‡•ç‡§ö‡•á ‡§õ‡§ø‡§™‡§æ‡§®‡§æ
            const css = '#rateContainer, #manualBalanceContainer, #addUserInputContainer { display:none !important; }';
            const style = document.createElement('style'); style.appendChild(document.createTextNode(css));
            document.head.appendChild(style);
        }
    }

    function generateInvite(role) {
        const link = `${window.location.origin}${window.location.pathname}?ref=${masterAdminId}&role=${role}`;
        window.open(`https://wa.me/?text=‡§π‡§æ‡§ú‡§º‡§ø‡§∞‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï‡§∞ ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡•ú‡•á‡§Ç: ${encodeURIComponent(link)}`);
    }

    // --- ‡§°‡•á‡§ü‡§æ ‡§∏‡§ø‡§Ç‡§ï ---
    function syncOnlineData() {
        db.collection("attendance").doc(masterAdminId).onSnapshot((doc) => {
            if(doc.exists) {
                data = doc.data().attendanceData || {};
                renderUserTabs();
                if(currentUser) selectUser(currentUser);
                else refreshUI();
            }
        });
    }

    function saveData() {
        db.collection("attendance").doc(masterAdminId).set({
            attendanceData: data, lastUpdated: new Date().toISOString()
        });
    }

    // --- ‡§ì‡§∞‡§ø‡§ú‡§ø‡§®‡§≤ ‡§ê‡§™ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®‡•ç‡§∏ ---
    function refreshUI() {
        if(!currentlyViewedPeriod) currentlyViewedPeriod = getCurrentPeriod();
        document.getElementById('currentMonthDisplay').innerText = currentlyViewedPeriod;
        renderTable();
        calculateSummary();
    }

    function getCurrentPeriod() {
        const d = new Date();
        const mKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        return calculationMode === 'fullMonth' ? mKey : mKey + (d.getDate()<=15 ? '_1' : '_2');
    }

    function renderUserTabs() {
        const container = document.getElementById('userTabs');
        container.innerHTML = '';
        Object.keys(data).sort().forEach(name => {
            const btn = document.createElement('button');
            btn.innerText = name;
            if(name === currentUser) btn.style.background = '#007bff';
            btn.onclick = () => selectUser(name);
            container.appendChild(btn);
        });
    }

    function selectUser(name) {
        currentUser = name;
        document.getElementById('selectedUserName').innerText = name;
        document.getElementById('userControl').classList.remove('hidden');
        document.getElementById('userRate').value = data[name].rate || 0;
        refreshUI();
    }

    function addUser() {
        const name = document.getElementById('newUserName').value.trim();
        if(name && !data[name]) {
            data[name] = { rate:0, months:{}, isActive:true };
            saveData();
            document.getElementById('newUserName').value = '';
        }
    }

    function renderTable() {
        const container = document.getElementById("tableContainer");
        if(!currentUser) return;
        const [mKey, part] = currentlyViewedPeriod.split('_');
        const [y, m] = mKey.split('-').map(Number);
        const days = new Date(y, m, 0).getDate();

        if(!data[currentUser].months[mKey]) data[currentUser].months[mKey] = { days:[] };
        let dData = data[currentUser].months[mKey].days;
        while(dData.length < days) dData.push({ status:'', overtime:0, received:0 });

        let start=0, end=days;
        if(calculationMode==='halfMonth') { if(part==='1') end=15; else start=15; }

        let html = `<table><thead><tr><th>Date</th><th>Status</th><th>OT</th><th>Rec</th></tr></thead><tbody>`;
        for(let i=start; i<end; i++) {
            const d = dData[i];
            html += `<tr>
                <td>${i+1}</td>
                <td><input type="text" value="${d.status}" onchange="updateCell(${i},'status',this.value)"></td>
                <td><input type="number" value="${d.overtime}" onchange="updateCell(${i},'overtime',this.value)"></td>
                <td><input type="number" value="${d.received}" onchange="updateCell(${i},'received',this.value)"></td>
            </tr>`;
        }
        container.innerHTML = html + `</tbody></table>`;
    }

    function updateCell(idx, field, val) {
        const mKey = currentlyViewedPeriod.split('_')[0];
        data[currentUser].months[mKey].days[idx][field] = field==='status' ? val.toUpperCase() : (parseFloat(val)||0);
        saveData();
    }

    function calculateSummary() {
        if(!currentUser) return;
        const [mKey, part] = currentlyViewedPeriod.split('_');
        const days = data[currentUser].months[mKey].days;
        let start=0, end=days.length;
        if(calculationMode==='halfMonth') { if(part==='1') end=15; else start=15; }

        let p=0, ot=0, rec=0;
        for(let i=start; i<end; i++) {
            const d = days[i];
            if(d.status==='P') p+=1; else if(d.status==='H') p+=0.5;
            else if(d.status.endsWith('P')) p += parseInt(d.status)||0;
            ot += Number(d.overtime)||0;
            rec += Number(d.received)||0;
        }
        const rate = data[currentUser].rate || 0;
        const total = (p * rate) + ((ot * rate)/8);
        document.getElementById('summarySection').innerHTML = `
            <div style="margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                <p>‡§π‡§æ‡§ú‡§º‡§ø‡§∞‡•Ä: ${p} ‡§¶‡§ø‡§® | ‡§ì‡§ü‡•Ä: ${ot} ‡§ò‡§Ç‡§ü‡•á</p>
                <h3 style="color:green;">‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ: ‚Çπ ${(total - rec).toFixed(2)}</h3>
            </div>`;
    }

    // --- ‡§Ö‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§ü‡§ø‡§≤‡§ø‡§ü‡•Ä ---
    document.getElementById('userRate').oninput = (e) => { data[currentUser].rate = parseFloat(e.target.value)||0; saveData(); };
    function logout() { auth.signOut().then(() => window.location.reload()); }
    function toggleDarkMode() { document.body.parentElement.classList.toggle('dark'); }
    function toggleLanguage() { /* ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç */ alert("Language toggled"); }
    function toggleCalculationMode() { calculationMode = calculationMode==='fullMonth'?'halfMonth':'fullMonth'; refreshUI(); }
</script>
</body>
</html>
