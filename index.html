<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker Pro Online</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        /* --- 1. ‡§Ü‡§™‡§ï‡•Ä ‡§´‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ CSS --- */
        :root {
            --background-color: #f4f4f4; --text-color: #333; --container-bg-color: #fff; --border-color: #ddd;
            --input-bg: #fff; --input-text: #333; --input-placeholder: #bbb; --table-bg: #fff; --table-header-bg: #ddd;
            --primary-color: #007bff; --danger-color: #dc3545; --warning-color: #ffc107;
            --icon-placeholder-color: #bbb; --current-day-bg: #e0e0e0;
        }
        html.dark {
            --background-color: #1a202c; --text-color: #a0aec0; --container-bg-color: #2d3748; --border-color: #4a5568;
            --input-bg: #2d3748; --input-text: #a0aec0; --table-bg: #2d3748; --table-header-bg: #4a5568;
        }
        body { font-family: Arial, sans-serif; padding: 10px; background-color: var(--background-color); color: var(--text-color); transition: 0.3s; }
        .container { display: flex; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; padding: 10px; background-color: var(--container-bg-color); border: 1px solid var(--border-color); border-radius: 5px; }
        
        /* Table Seamless Look (From your file) */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: var(--table-bg); table-layout: fixed; border: 1px solid var(--border-color); }
        th, td { border: 1px solid var(--border-color); padding: 4px; text-align: center; word-wrap: break-word; position: relative; vertical-align: middle; }
        th { background-color: var(--table-header-bg); font-size: 13px; }
        
        /* Columns Width */
        th:nth-child(1), td:nth-child(1) { width: 75px; } /* Date */
        th:nth-child(2), td:nth-child(2) { width: 35px; } /* Status */
        th:nth-child(3), td:nth-child(3) { width: 30px; } /* OT */
        th:nth-child(4), td:nth-child(4), th:nth-child(5), td:nth-child(5), th:nth-child(6), td:nth-child(6) { width: 35px; } /* Rent, Food, Rec */
        th:nth-child(8), td:nth-child(8) { width: 55px; } /* Edited */

        td input { border: none !important; background: transparent !important; text-align: center; width: 100%; height: 100%; color: inherit; font-size: 14px; outline: none; padding: 5px 0; }
        .status-cell-absent { background-color: #ffebee !important; color: #d32f2f !important; }
        
        /* Icon Placeholders (The Magic Part) */
        .rent-cell:not(.has-val)::before, .food-cell:not(.has-val)::before, .received-cell:not(.has-val)::before {
            font-family: "Font Awesome 5 Free"; font-weight: 900; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            color: var(--icon-placeholder-color); opacity: 0.5; font-size: 12px; pointer-events: none;
        }
        .rent-cell::before { content: "\f015"; }
        .food-cell::before { content: "\f2e7"; }
        .received-cell::before { content: "\f53a"; }
        .has-val::before { display: none !important; }

        /* Sticky Column for Mobile */
        @media (max-width: 768px) {
            th:nth-child(1), td:nth-child(1) { position: sticky; left: 0; z-index: 10; background-color: var(--container-bg-color); border-right: 2px solid #bbb; }
        }

        /* Bill Style */
        .bill-container { display: flex; flex-wrap: wrap; background: var(--container-bg-color); border: 1px solid var(--border-color); border-radius: 8px; margin-top: 10px; font-family: monospace; }
        .bill-col { flex: 1; min-width: 250px; padding: 15px; border-right: 1px dashed var(--border-color); }
        .bill-footer { width: 100%; background: var(--primary-color); color: #fff; padding: 15px; font-size: 18px; font-weight: bold; text-align: center; }

        /* Multi-user UI */
        #authBox { max-width: 400px; margin: 50px auto; padding: 30px; border-radius: 12px; background: white; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #authBox input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        .nav-online { background: #343a40; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- ‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® -->
    <div id="authBox">
        <h2>Attendance Login</h2>
        <input type="email" id="loginEmail" placeholder="‡§à‡§Æ‡•á‡§≤">
        <input type="password" id="loginPass" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°">
        <button onclick="handleAuth('login')" style="width:100%; padding:12px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;">Login</button>
        <button id="signupBtn" onclick="handleAuth('signup')" style="width:100%; padding:12px; background:#28a745; color:white; border:none; border-radius:6px; margin-top:10px; cursor:pointer;">Signup (Admin Only)</button>
        <p id="inviteMsg" style="color:blue; margin-top:10px;"></p>
    </div>

    <!-- ‡§Ö‡§∏‡§≤‡•Ä ‡§ê‡§™ -->
    <div id="appContainer" class="hidden">
        <div class="nav-online">
            <div><span id="userEmailDisplay"></span> <span id="userRoleDisplay" style="background:gold; color:black; padding:2px 5px; border-radius:4px; font-size:10px;"></span></div>
            <button onclick="auth.signOut().then(()=>location.reload())" style="color:white; border:1px solid white; background:none; padding:2px 8px; border-radius:4px;">Logout</button>
        </div>

        <div id="invitePanel" class="container hidden" style="background:#e9ecef;">
            <b>Invite Link:</b>
            <button onclick="generateInvite('super')" id="btnInvSuper" style="background:orange; color:white; border:none; padding:5px 10px; border-radius:4px; margin-left:5px;">‡§†‡•á‡§ï‡•á‡§¶‡§æ‡§∞</button>
            <button onclick="generateInvite('user')" style="background:green; color:white; border:none; padding:5px 10px; border-radius:4px; margin-left:5px;">‡§µ‡§∞‡•ç‡§ï‡§∞</button>
        </div>

        <div id="controlsHeader" class="container" style="justify-content: space-between;">
            <h2 style="margin:0;">Attendance</h2>
            <div>
                <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
                <button onclick="toggleCalculationMode()">üìÖ</button>
            </div>
        </div>

        <div id="addUserInputContainer" class="container">
            <input type="text" id="newUserName" placeholder="‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ" style="flex-grow: 1;">
            <button onclick="addUser()">‚ûï</button>
        </div>

        <div id="userTabs" class="container"></div>

        <div id="userControl" class="hidden">
            <h3 id="selectedWorkerTitle" style="margin:5px 0;"></h3>
            <div id="userQuickControls" class="container">
                <div>Rate: <input type="number" id="userRate" style="width:60px;"></div>
                <div>Prev Bal: <input type="number" id="manualCarriedOverBalance" style="width:60px;"></div>
            </div>
            
            <div class="container" style="justify-content: space-between;">
                <button onclick="changePeriod(-1)">‚ùÆ Prev</button>
                <span id="currentMonthDisplay" style="font-weight:bold;"></span>
                <button onclick="changePeriod(1)">Next ‚ùØ</button>
            </div>

            <div id="tableContainer" class="table-responsive"></div>
            <div id="summarySection"></div>
            <button onclick="shareReport()" style="width:100%; background:#007bff; color:white; padding:10px; border:none; border-radius:5px; margin-top:10px;">Share Report (Image)</button>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:10px; width:90%; max-width:400px;">
            <h3>Notes</h3>
            <textarea id="modalNoteTextarea" style="width:100%; height:100px; padding:10px;"></textarea><br><br>
            <button onclick="saveNote()" style="background:green; color:white; padding:8px 20px; border:none; border-radius:5px;">Save</button>
            <button onclick="document.getElementById('notesModal').classList.add('hidden')" style="background:#ccc; padding:8px 20px; border:none; border-radius:5px; margin-left:10px;">Close</button>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG (‡§Ü‡§™‡§ï‡•Ä API Keys) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCFZL-_arIus7bnA4U9kKw0uhIet6Ng3SU",
        authDomain: "my-attendance-795fa.firebaseapp.com",
        projectId: "my-attendance-795fa",
        storageBucket: "my-attendance-795fa.firebasestorage.app",
        messagingSenderId: "462347673756",
        appId: "1:462347673756:web:bd69375de1db201b550d59",
        measurementId: "G-B03E17HG43"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let data = {};
    let currentUser = null;
    let loggedInUser = null;
    let masterAdminId = null;
    let calculationMode = 'fullMonth';
    let currentlyViewedPeriod = null;

    // --- ‡§≤‡•â‡§ó‡§ø‡§® ‡§≤‡•â‡§ú‡§ø‡§ï ---
    const urlParams = new URLSearchParams(window.location.search);
    const inviteRole = urlParams.get('role');
    const refAdminId = urlParams.get('ref');
    const inviterUid = urlParams.get('by');

    if(inviteRole) document.getElementById('inviteMsg').innerText = "Joining as: " + inviteRole.toUpperCase();

    async function handleAuth(type) {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        try {
            if(type === 'signup') {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection("users").doc(res.user.uid).set({
                    uid: res.user.uid, email, role: inviteRole || 'admin', 
                    adminId: refAdminId || res.user.uid, invitedBy: inviterUid || 'admin'
                });
            } else { await auth.signInWithEmailAndPassword(email, pass); }
        } catch (e) { alert(e.message); }
    }

    auth.onAuthStateChanged(async (user) => {
        if(user) {
            const doc = await db.collection("users").doc(user.uid).get();
            loggedInUser = doc.data();
            masterAdminId = loggedInUser.adminId;
            document.getElementById('authBox').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('userEmailDisplay').innerText = user.email;
            document.getElementById('userRoleDisplay').innerText = loggedInUser.role.toUpperCase();
            setupPermissions();
            listenToData();
        } else {
            document.getElementById('authBox').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }
    });

    function setupPermissions() {
        const r = loggedInUser.role;
        if(r === 'admin') document.getElementById('invitePanel').classList.remove('hidden');
        if(r === 'super') { document.getElementById('invitePanel').classList.remove('hidden'); document.getElementById('btnInvSuper').classList.add('hidden'); }
        if(r === 'user') {
            document.getElementById('addUserInputContainer').classList.add('hidden');
            document.getElementById('userTabs').classList.add('hidden');
            document.getElementById('userQuickControls').classList.add('hidden');
        }
    }

    function generateInvite(role) {
        const link = `${window.location.origin}${window.location.pathname}?ref=${masterAdminId}&role=${role}&by=${loggedInUser.uid}`;
        window.open(`https://wa.me/?text=‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§π‡§æ‡§ú‡§º‡§ø‡§∞‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï‡§∞ ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡•ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§ø‡§Ç‡§ï ‡§ñ‡•ã‡§≤‡•á‡§Ç: ${encodeURIComponent(link)}`);
    }

    // --- ‡§°‡•á‡§ü‡§æ ‡§∏‡§ø‡§Ç‡§ï ---
    function listenToData() {
        db.collection("attendance").doc(masterAdminId).onSnapshot((doc) => {
            if(doc.exists) {
                data = doc.data().attendanceData || {};
                renderTabs();
            }
        });
    }

    function saveData() {
        db.collection("attendance").doc(masterAdminId).set({
            attendanceData: data, lastUpdated: new Date().toISOString()
        });
    }

    // --- 2P, 3P, H, OT ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§∂‡§® ‡§î‡§∞ ‡§ü‡•á‡§¨‡§≤ ---
    function renderTabs() {
        const tabs = document.getElementById('userTabs');
        tabs.innerHTML = '';
        const names = Object.keys(data).sort();

        if(loggedInUser.role === 'user') {
            currentUser = loggedInUser.email;
            if(!data[currentUser]) {
                data[currentUser] = { rate:0, invitedBy: loggedInUser.invitedBy, months:{} };
                saveData();
            }
            selectUser(currentUser);
        } else {
            let visible = names;
            if(loggedInUser.role === 'super') visible = names.filter(n => data[n].invitedBy === loggedInUser.uid);
            visible.forEach(n => {
                const btn = document.createElement('button');
                btn.innerText = n;
                if(n === currentUser) btn.style.border = '2px solid #007bff';
                btn.onclick = () => selectUser(n);
                tabs.appendChild(btn);
            });
        }
    }

    function selectUser(name) {
        currentUser = name;
        document.getElementById('selectedWorkerTitle').innerText = name;
        document.getElementById('userControl').classList.remove('hidden');
        document.getElementById('userRate').value = data[name].rate || 0;
        
        const mKey = getCurrentMonthKey();
        if(data[name].months && data[name].months[mKey]) {
            document.getElementById('manualCarriedOverBalance').value = data[name].months[mKey].carriedOverBalance || 0;
        }
        refreshApp();
    }

    function refreshApp() {
        if(!currentlyViewedPeriod) currentlyViewedPeriod = getCurrentPeriod();
        document.getElementById('currentMonthDisplay').innerText = currentlyViewedPeriod;
        renderTable();
        showSummary();
    }

    function getCurrentMonthKey() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    function getCurrentPeriod() {
        const d = new Date();
        const mKey = getCurrentMonthKey();
        return calculationMode === 'fullMonth' ? mKey : mKey + (d.getDate()<=15 ? '_1' : '_2');
    }

    function renderTable() {
        const container = document.getElementById("tableContainer");
        if(!currentUser) return;
        const [mKey, part] = currentlyViewedPeriod.split('_');
        const [y, mIdx] = mKey.split('-').map(Number);
        const totalDays = new Date(y, mIdx, 0).getDate();

        if(!data[currentUser].months[mKey]) data[currentUser].months[mKey] = { days:[] };
        let dData = data[currentUser].months[mKey].days;
        while(dData.length < totalDays) dData.push({ status:'', overtime:0, rent:0, food:0, received:0, notes:'', updated:'' });

        let start=0, end=totalDays;
        if(calculationMode==='halfMonth') { if(part==='1') end=15; else start=15; }

        let html = `<table><thead><tr>
            <th>Date</th><th>St.</th><th>OT</th><th>Rt</th><th>Fd</th><th>Rc</th><th>Nt</th><th>Ed</th>
            </tr></thead><tbody>`;
        
        for(let i=start; i<end; i++) {
            const d = dData[i];
            const dateObj = new Date(y, mIdx-1, i+1);
            const isSun = dateObj.getDay()===0;
            const dayName = new Intl.DateTimeFormat('hi-IN', { weekday: 'short' }).format(dateObj);
            
            const rentCls = Number(d.rent)?'has-val':'rent-cell';
            const foodCls = Number(d.food)?'has-val':'food-cell';
            const recCls = Number(d.received)?'has-val':'received-cell';

            let editTime = "";
            if(d.updated) {
                const ud = new Date(d.updated);
                editTime = ud.getHours() + ":" + String(ud.getMinutes()).padStart(2,'0');
            }

            html += `<tr style="${isSun?'background:var(--sunday-bg-light)':''}">
                <td style="font-size:10px;">${dayName}<br>${i+1}/${mIdx}</td>
                <td class="${d.status==='A'?'status-cell-absent':''}"><input type="text" value="${d.status}" onchange="updateCell(${i},'status',this.value)"></td>
                <td><input type="number" value="${d.overtime||''}" onchange="updateCell(${i},'overtime',this.value)"></td>
                <td class="${rentCls}"><input type="number" value="${d.rent||''}" onchange="updateCell(${i},'rent',this.value)"></td>
                <td class="${foodCls}"><input type="number" value="${d.food||''}" onchange="updateCell(${i},'food',this.value)"></td>
                <td class="${recCls}"><input type="number" value="${d.received||''}" onchange="updateCell(${i},'received',this.value)"></td>
                <td onclick="openNote(${i})" style="font-size:10px;">${d.notes?'üìù':'+'}</td>
                <td style="font-size:8px;">${editTime}</td>
            </tr>`;
        }
        container.innerHTML = html + `</tbody></table>`;
    }

    function updateCell(idx, field, val) {
        const mKey = currentlyViewedPeriod.split('_')[0];
        const day = data[currentUser].months[mKey].days[idx];
        day[field] = (field==='status')? val.toUpperCase() : (parseFloat(val)||0);
        day.updated = new Date().toISOString();
        saveData();
    }

    function showSummary() {
        const div = document.getElementById('summarySection');
        if(!currentUser) return;
        const [mKey, part] = currentlyViewedPeriod.split('_');
        const days = data[currentUser].months[mKey].days;
        let start=0, end=days.length;
        if(calculationMode==='halfMonth') { if(part==='1') end=15; else start=15; }

        let p=0, ot=0, rent=0, food=0, rec=0;
        days.slice(start, end).forEach(d => {
            const s = d.status.toUpperCase();
            if(s==='P') p+=1; else if(s==='H') p+=0.5;
            else if(s.endsWith('P')) p += parseInt(s)||0;
            ot += Number(d.overtime)||0;
            rent += Number(d.rent)||0;
            food += Number(d.food)||0;
            rec += Number(d.received)||0;
        });

        const rate = data[currentUser].rate || 0;
        const prevBal = data[currentUser].months[mKey].carriedOverBalance || 0;
        const totalEarn = (p * rate) + ((ot * rate)/8) + rent + food + prevBal;

        div.innerHTML = `
            <div class="bill-container">
                <div class="bill-col">
                    <div class="bill-header">Account Details</div>
                    <div class="bill-row"><span>Attendance (${p}):</span> <span>${(p*rate).toFixed(2)}</span></div>
                    <div class="bill-row"><span>Overtime (${ot}h):</span> <span>${((ot*rate)/8).toFixed(2)}</span></div>
                    <div class="bill-row"><span>Rent/Food:</span> <span>${(rent+food).toFixed(2)}</span></div>
                    <div class="bill-row"><span>Prev Balance:</span> <span>${prevBal.toFixed(2)}</span></div>
                </div>
                <div class="bill-col">
                    <div class="bill-header">Deductions</div>
                    <div class="bill-row"><span>Total Received:</span> <span style="color:red;">${rec.toFixed(2)}</span></div>
                </div>
                <div class="bill-footer">Net Payable: ‚Çπ ${(totalEarn - rec).toFixed(2)}</div>
            </div>`;
    }

    // --- ‡§Ö‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§ü‡§ø‡§≤‡§ø‡§ü‡•Ä ---
    function addUser() {
        const name = document.getElementById('newUserName').value.trim();
        if(name && !data[name]) {
            data[name] = { rate:0, invitedBy: loggedInUser.uid, months:{}, isActive:true };
            saveData();
            document.getElementById('newUserName').value = '';
        }
    }
    document.getElementById('userRate').oninput = (e) => { if(currentUser){ data[currentUser].rate = parseFloat(e.target.value)||0; saveData(); } };
    document.getElementById('manualCarriedOverBalance').oninput = (e) => { 
        if(currentUser){
            const mKey = currentlyViewedPeriod.split('_')[0];
            if(!data[currentUser].months[mKey]) data[currentUser].months[mKey] = { days:[] };
            data[currentUser].months[mKey].carriedOverBalance = parseFloat(e.target.value)||0; 
            saveData(); 
        }
    };
    
    let activeNoteIdx = null;
    function openNote(idx) { 
        activeNoteIdx = idx;
        const mKey = currentlyViewedPeriod.split('_')[0];
        document.getElementById('modalNoteTextarea').value = data[currentUser].months[mKey].days[idx].notes || '';
        document.getElementById('notesModal').classList.remove('hidden');
    }
    function saveNote() {
        const mKey = currentlyViewedPeriod.split('_')[0];
        data[currentUser].months[mKey].days[activeNoteIdx].notes = document.getElementById('modalNoteTextarea').value;
        saveData(); document.getElementById('notesModal').classList.add('hidden');
    }

    function toggleDarkMode() { document.body.parentElement.classList.toggle('dark'); }
    function toggleCalculationMode() { calculationMode = (calculationMode==='fullMonth'?'halfMonth':'fullMonth'); currentlyViewedPeriod=null; refreshApp(); }
    function changePeriod(dir) { alert("Navigation feature updated for cloud!"); }
    async function shareReport() {
        const area = document.getElementById('reportArea');
        const canvas = await html2canvas(area, { scale: 2 });
        const link = document.createElement('a');
        link.download = `Report_${currentUser}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
</body>
</html>
