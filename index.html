 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="appTitle">Attendance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">


<!-- Firebase Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>


    <style>
        /* --- Start of CSS --- */
        :root {
            --background-color: #f4f4f4;
            --text-color: #333;
            --container-bg-color: #fff;
            --border-color: #ddd;
            --input-bg: #fff;
            --input-text: #333;
            --input-placeholder: #bbb;
            --table-bg: #fff;
            --table-header-bg: #ddd;

            /* Button Variables (Light Mode Defaults) */
            --default-button-bg: transparent;
            --default-button-text: #333;
            --default-button-border: #ccc;
            --default-button-hover-bg: #e9e9e9;
            --default-button-hover-border: #adadad;

            --primary-color: #007bff;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --reminder-bg: #ffc107;
            --reminder-text: #343a40;
            --current-day-bg: #e0e0e0;
            --icon-placeholder-color: #bbb; /* Light mode default */
            --link-color: #0056b3; /* Added for hover effect */
            --text-color-secondary: #555; /* For day name */

            /* Friday/Sunday highlighting - Lighter versions */
            --friday-bg-light: #f0fff9;
            --friday-border-light: #239c88; /* Specific border color for Friday */
            --sunday-bg-light: #fff5f7;
            --sunday-border-light: #e53e3e; /* Specific border color for Sunday */

            /* Save Status Indicator Colors */
            --save-success-bg: #4CAF50;
            --save-saving-bg: var(--warning-color);
            --save-error-bg: var(--danger-color);
            --save-text-color: white;
        }

        html.dark {
            --background-color: #1a202c;
            --text-color: #a0aec0; /* Slightly lighter text for dark background */
            --container-bg-color: #2d3748; /* Darker background for main containers */
            --border-color: #4a5568;
            --input-bg: #2d3748;
            --input-text: #a0aec0;
            --input-placeholder: #718096;
            --table-bg: #2d3748;
            --table-header-bg: #4a5568;

            /* Button Variables (Dark Mode) */
             --default-button-bg: transparent;
             --default-button-text: #a0aec0;
             --default-button-border: #4a5568;
             --default-button-hover-bg: rgba(74, 85, 104, 0.4);
             --default-button-hover-border: #a0aec0;


             --primary-color-dark: #63b3ed;
             --danger-color-dark: #fc8181;
             --warning-color-dark: #f6e05e;
             --reminder-bg: #f6ad55;
             --reminder-text: #2d3748;
            --current-day-bg: #4a5568;
            --icon-placeholder-color-dark: #718096;
             --link-color: #90cdf4;
             --text-color-secondary: #8892b0;

            /* Friday/Sunday highlighting - Dark Mode - Lighter versions */
            --friday-bg-dark: #2a4365;
            --friday-border-dark: #73b8e0; /* Specific border color for Friday in dark mode */
            --sunday-bg-dark: #822c2c;
            --sunday-border-dark: #fca5a5; /* Specific border color for Sunday in dark mode */

            /* Save Status Indicator Colors - Dark Mode */
            --save-success-bg: var(--primary-color-dark);
            --save-saving-bg: var(--warning-color-dark);
            --save-error-bg: var(--danger-color-dark);
            --save-text-color: var(--background-color); /* Use background color for text on dark buttons */
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            background-color: var(--container-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        input, select, textarea { /* Added textarea */
            padding: 6px;
            margin: 5px 0;
            font-size: 14px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--input-text);
            box-sizing: border-box;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
         select { cursor: pointer; }
         textarea { resize: vertical; } /* Allow vertical resize for textarea */


        td input {
             border: none; background: none; padding: 0; margin: 0;
             text-align: center; display: block; width: 100%; height: 100%;
             box-sizing: border-box; color: inherit;
         }
         td.edited-datetime-cell {
             padding: 1px 2px;
             vertical-align: middle;
         }
         .edited-date-input, .edited-time-input {
             display: block;
             width: 100%;
             margin: 1px auto;
             text-align: center;
             font-size: 0.80em;
             padding: 2px 1px;
             border: 1px solid var(--border-color);
             background-color: var(--input-bg);
             color: var(--input-text);
             box-sizing: border-box;
             line-height: 1.2;
         }


         input::placeholder, td input::placeholder, textarea::placeholder { color: var(--input-placeholder); opacity: 1; }

         td.rent-cell input[data-field="rent"],
         td.food-cell input[data-field="food"],
         td.received-cell input[data-field="received"] {
            padding-left: 0; text-align: center;
         }

        button {
            cursor: pointer;
            background-color: var(--default-button-bg);
            color: var(--default-button-text);
            border: 1px solid var(--default-button-border);
            border-radius: 4px; padding: 6px 10px;
            margin: 5px; font-size: 16px; min-width: 35px; text-align: center;
            display: inline-block; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        button:hover {
            background-color: var(--default-button-hover-bg);
            border-color: var(--default-button-hover-border);
            color: var(--default-button-text);
        }
        button:disabled { color: #aaa; border-color: #ddd; background-color: transparent; cursor: not-allowed; }
        html.dark button:disabled { color:#5a6578; border-color:#404a59; background-color:transparent; }
        html.dark button:disabled:hover { background-color:transparent; }


         #addUserBtn {
             width: 35px; font-size: 18px; padding: 6px;
             border-color: #4CAF50; color: #4CAF50;
             margin: 5px;
         }
         #addUserBtn:hover { background-color: #4CAF50; color: white; border-color: #4CAF50; }

        html.dark #addUserBtn { border-color:#48bb78; color:#48bb78; }
        html.dark #addUserBtn:hover { background-color:#48bb78; color: var(--background-color); }


        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: var(--table-bg); table-layout: fixed; border: 1px solid var(--border-color); }
         th, td {
            border: 1px solid var(--border-color); padding: 4px; text-align: center;
            word-wrap: break-word; vertical-align: top; position: relative;
         }
         th {
             background-color: var(--table-header-bg); font-weight: bold;
             border-bottom: 1px solid var(--border-color);
             padding: 4px;
             line-height: 1.2;
             color: var(--text-color);
        }

        th:nth-child(1), td:nth-child(1) { width: 90px; } /* Date */
        th:nth-child(2), td:nth-child(2) { width: 25px; } /* Status */
        th:nth-child(3), td:nth-child(3) { width: 25px; } /* Overtime */
        th:nth-child(4), td:nth-child(4) { width: 25px; } /* Rent */
        th:nth-child(5), td:nth-child(5) { width: 25px; } /* Food */
        th:nth-child(6), td:nth-child(6) { width: 25px; } /* Received */
        th:nth-child(7), td:nth-child(7) { width: auto; min-width: 80px; } /* Notes */
        th:nth-child(8), td:nth-child(8) { width: 75px; } /* Edited */

        .day-name-in-date-cell {
            display: block;
            font-size: 0.8em;
            color: var(--text-color-secondary);
            line-height: 1;
            margin-bottom: 2px;
        }
        .notes-cell {
            cursor: pointer;
            text-align: left;
            padding-left: 5px !important;
            vertical-align: middle !important;
        }
        .note-preview {
            display: inline-block;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
            font-size: 0.9em;
            color: var(--input-text);
            min-height: 1.2em;
        }
        html.dark .note-preview {
            color: var(--input-text);
        }


        .rent-cell:not(.input-has-value)::before,
        .food-cell:not(.input-has-value)::before,
        .received-cell:not(.input-has-value)::before {
            font-family: "Font Awesome 5 Free"; font-weight: 900; position: absolute;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
            color: var(--icon-placeholder-color); opacity: 0.7; font-size: 10px; z-index: 1;
            content: var(--icon-content, "");
        }
        .rent-cell::before { --icon-content: "\f015"; }
        .food-cell::before { --icon-content: "\f2e7"; }
        .received-cell::before { --icon-content: "\f53a"; }

        html.dark .rent-cell:not(.input-has-value)::before,
        html.dark .food-cell:not(.input-has-value)::before,
        html.dark .received-cell:not(.input-has-value)::before {
             color: var(--icon-placeholder-color-dark);
        }
        .input-has-value::before { display: none !important; }

         #userTabs {
             margin-top: 10px; margin-bottom: 20px; padding: 10px;
             background-color: var(--container-bg-color);
             border: 1px solid var(--border-color);
             border-radius: 5px; display: flex; flex-wrap: wrap; gap: 5px;
             display: none;
         }
         #userTabs button.user-tab-button {
             margin: 0; background-color: #f0f0f0; border: 1px solid #ccc; color: #333;
             padding: 4px 8px;
         }
         #userTabs button.user-tab-button:hover { background-color: #dcdcdc; border-color: #bbb; }
         #userTabs button.user-tab-button.active-user-tab {
             background-color: transparent; border: 1px solid var(--primary-color);
             color: var(--primary-color); font-weight: bold;
         }
         #userTabs button.user-tab-button.active-user-tab:hover {
              background-color: rgba(0, 123, 255, 0.1); border-color: #0056b3; color: #0056b3;
         }
         #userTabs button.user-tab-button.archived {
              background-color: transparent; border: 1px dashed #aaa; color: #777;
         }
          #userTabs button.user-tab-button.archived:hover {
              background-color: #f0f0f0; border-color: #888; color: #555;
          }

        html.dark #userTabs button.user-tab-button {
             background-color: rgba(74, 85, 104, 0.5);
             border-color: var(--default-button-border);
             color: var(--default-button-text);
        }
        html.dark #userTabs button.user-tab-button:hover {
             background-color: var(--default-button-hover-bg);
             border-color: var(--default-button-hover-border);
             color: var(--default-button-text);
        }
        html.dark #userTabs button.user-tab-button.active-user-tab {
            background-color: transparent; border-color:var(--primary-color-dark); color:var(--primary-color-dark);
        }
        html.dark #userTabs button.user-tab-button.active-user-tab:hover { background-color:rgba(100,181,246,0.15); }
        html.dark #userTabs button.user-tab-button.archived { border-style:dashed; border-color:#718096; color:#a0aec0; }
        html.dark #userTabs button.user-tab-button.archived:hover { background-color:var(--default-button-hover-bg); }


         #userControl {
             margin-top: 20px; padding: 10px;
             background-color: var(--container-bg-color);
             border: 1px solid var(--border-color);
             border-radius: 5px;
             display: none;
         }
          #userControl > div {
              display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
          }
          #userControl > div:first-child {
              justify-content: space-between;
          }
          #userControl > div:last-child {
              margin-bottom: 0;
          }
          #userQuickControls {
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
              align-items: center;
              width: 100%;
              margin-bottom: 15px;
          }
           #userQuickControls > div {
               display: flex;
               align-items: center;
               gap: 5px;
               margin-bottom: 0;
               flex-grow: 1;
               flex-basis: 120px;
               min-width: 100px;
           }
           #userQuickControls label {
               display: none; /* Keep labels for accessibility, but hide visually for compact layout */
           }
           #userQuickControls input,
           #userQuickControls select {
               flex-grow: 1;
               min-width: 0;
               margin: 0;
               font-size: 13px;
               padding: 4px 6px;
               height: calc(1em + 8px + 2px); /* Adjusted for better consistency */
           }
           #userControl button { margin: 0; }

          #monthNavWrapper { width: 100%; margin-bottom: 10px; }
          #monthNav {
             display: flex; justify-content: space-between; align-items: center; width: 100%;
          }
          #monthNav .month-display-group { display: flex; align-items: center; gap: 5px; }
          #monthNav button { padding: 4px 8px; font-size: 14px; margin: 0; }
          #currentMonthDisplay { font-size: 1.1em; font-weight: bold; min-width: 150px; text-align: center; }

          #viewReportButtonsWrapper {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-top: 15px; margin-bottom: 10px; gap: 5px;
            flex-wrap: wrap; /* Allow buttons to wrap */
          }
          #viewReportButtonsWrapper button {
            flex-grow: 1;
            margin: 2px 0; /* Add small vertical margin for wrapped buttons */
            min-width: 120px; /* Ensure buttons don't get too squished */
            font-size: 0.85em; /* Slightly smaller font for more buttons */
            padding: 5px 8px;
        }

          #reportArea { margin-top: 10px; }

         #overallSummarySection {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; margin-bottom: 10px;
             display: none;
         }
         #overallSummarySection h3 { margin-top: 0; }
         #overallSummarySection hr { border-color: var(--border-color); margin: 0.5rem 0; }
         #overallSummarySection p { margin: 0.2em 0; }

         #summarySection {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; margin-bottom: 10px;
         }
         #summarySection h3 { margin-top: 0; }
         #summarySection hr { border-color: var(--border-color); margin: 0.5rem 0; }
         #summarySection p { margin: 0.2em 0; }

         #reportFooter {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; white-space: pre-wrap; font-size: 0.9em;
         }

         #dataManagementButtons {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
             display: none;
         }
         #dataManagementButtons button { margin: 0; padding: 6px 12px; font-size: 0.9em; }
         #dataManagementButtons button i { margin-right: 5px; }
        #archiveUserBtn.archive-style { border-color: #dc3545; color: #dc3545; }
        #archiveUserBtn.archive-style:hover { background-color: #dc3545; color: white; }
        #archiveUserBtn.reactivate-style { border-color: #ffc107; color: #b7791f; }
        #archiveUserBtn.reactivate-style:hover { background-color: #ffc107; color: #212529; }

        html.dark #archiveUserBtn.archive-style { border-color:var(--danger-color-dark); color:var(--danger-color-dark); }
        html.dark #archiveUserBtn.archive-style:hover { background-color:var(--danger-color-dark); color:var(--background-color); }
        html.dark #archiveUserBtn.reactivate-style { border-color:var(--warning-color-dark); color:var(--warning-color-dark); }
        html.dark #archiveUserBtn.reactivate-style:hover { background-color:var(--warning-color-dark); color:var(--reminder-text); }
        
        #clearAllBalancesBtn { border-color: var(--danger-color); color: var(--danger-color); }
        #clearAllBalancesBtn:hover { background-color: var(--danger-color); color: white; }
        html.dark #clearAllBalancesBtn { border-color:var(--danger-color-dark); color:var(--danger-color-dark); }
        html.dark #clearAllBalancesBtn:hover { background-color:var(--danger-color-dark); color:var(--background-color); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: var(--container-bg-color); margin: 10% auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .modal-title { margin: 0; font-size: 1.2em; font-weight: bold; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; cursor: pointer; }
        html.dark .close-button { color: #ccc; }
        html.dark .close-button:hover, html.dark .close-button:focus { color: #fff; }

        .modal-body { margin-bottom: 10px; }
         #modalNoteTextarea {
             width: 100%;
             font-size: 1em;
             padding: 8px;
             box-sizing: border-box;
             border: 1px solid var(--border-color);
             background-color: var(--input-bg);
             color: var(--input-text);
             border-radius: 4px;
             min-height: 80px;
         }
         html.dark #modalNoteTextarea {}

        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { padding: 8px 15px; margin: 0; }

        .modal-footer button[onclick*="closeImportModal"] { border-color: #6c757d; color: #6c757d; }
        .modal-footer button[onclick*="closeImportModal"]:hover { background-color: #6c757d; color: white; }
        .modal-footer button[onclick*="confirmImport('merge')"] { border-color: var(--primary-color); color: var(--primary-color); }
        .modal-footer button[onclick*="confirmImport('merge')"]:hover { background-color: var(--primary-color); color: white; }
        .modal-footer button[onclick*="confirmImport('replace')"] { border-color: var(--danger-color); color: var(--danger-color); }
        .modal-footer button[onclick*="confirmImport('replace')"]:hover { background-color: var(--danger-color); color: white; }

        html.dark .modal-footer button[onclick*="closeImportModal"] { border-color:#90a4ae; color:#90a4ae;}
        html.dark .modal-footer button[onclick*="closeImportModal"]:hover { background-color:#90a4ae; color:var(--background-color); }
        html.dark .modal-footer button[onclick*="confirmImport('merge')"] { border-color:var(--primary-color-dark); color:var(--primary-color-dark); }
        html.dark .modal-footer button[onclick*="confirmImport('merge')"]:hover { background-color:var(--primary-color-dark); color:var(--background-color); }
        html.dark .modal-footer button[onclick*="confirmImport('replace')"] { border-color:var(--danger-color-dark); color:var(--danger-color-dark); }
        html.dark .modal-footer button[onclick*="confirmImport('replace')"]:hover { background-color:var(--danger-color-dark); color:var(--background-color); }

        .preview-section { border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .preview-header { font-weight: bold; margin-bottom: 5px; }
        .user-preview { border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; background-color: var(--input-bg); margin-top: 10px; }
        .user-preview p { margin: 0.3em 0; font-size: 0.9em; }
        .import-option { margin-top: 15px; }
        .import-option ul { list-style: disc inside; margin: 0; padding-left: 20px; }
        .import-option li { margin-bottom: 5px; }

        #previousBalancePaymentsSection {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; margin-bottom: 10px;
             display: none;
         }
         #previousBalancePaymentsSection h3 { margin-top: 0; font-size: 1.1em; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
         #previousBalancePaymentsSection .payment-entry { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dashed #eee; }
         html.dark #previousBalancePaymentsSection .payment-entry { border-bottom-color: rgba(255,255,255,0.1); }

         #previousBalancePaymentsSection .payment-entry:last-child { border-bottom: none; }
         #previousBalancePaymentsSection .payment-details { flex-grow: 1; margin-right: 10px; font-size: 0.9em; }

         .delete-payment-btn {
             background-color: transparent; color: #dc3545; border: 1px solid #dc3545;
             border-radius: 3px; padding: 1px 4px; font-size: 0.8em; cursor: pointer;
             margin-left: 10px; flex-shrink: 0; margin: 0;
         }
         .delete-payment-btn:hover { background-color: #dc3545; color: white; }
         html.dark .delete-payment-btn { border-color:var(--danger-color-dark); color:var(--danger-color-dark); }
         html.dark .delete-payment-btn:hover { background-color:var(--danger-color-dark); color:var(--background-color); }

         #addPaymentForm {
             margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);
             display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
         }
         #addPaymentForm label { font-size: 0.9em; }
         #addPaymentForm input[type="number"],
         #addPaymentForm input[type="date"],
         #addPaymentForm input[type="text"] {
             flex-grow: 1; min-width: 100px; margin: 0;
        }
          @media (min-width: 640px) {
              #addPaymentForm input[type="number"],
              #addPaymentForm input[type="date"],
              #addPaymentForm input[type="text"] {
                  flex-grow: 0;
                  width: auto;
                  min-width: unset;
              }
              #addPaymentForm input[type="number"] { width: 80px;}
              #addPaymentForm input[type="text"] { width: 150px;}
        }

         #addPaymentForm button {
             margin: 0; padding: 6px 12px; font-size: 1em;
             border-color: var(--primary-color); color: var(--primary-color); background-color: transparent; width: 100%;
        }
          @media (min-width: 640px) { #addPaymentForm button { width: auto; flex-grow: 0; } }

        #addPaymentForm button:hover { background-color: var(--primary-color); color: white; }
        html.dark #addPaymentForm button { border-color:var(--primary-color-dark); color:var(--primary-color-dark); }
        html.dark #addPaymentForm button:hover { background-color:var(--primary-color-dark); color:var(--background-color); }

        #controlsHeader {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);
        }
        #appTitle { margin: 0; font-size: 1.5em; }
        #topControls { display: flex; gap: 5px; align-items: center; flex-wrap: wrap;}
        #topControls button { margin: 0; padding: 4px 6px; font-size: 0.9em; }

        .control-icon { font-size: 1.2em; border: none; background: none; padding: 0; margin: 0; color: var(--text-color); }
        .control-icon:hover { color: var(--input-placeholder); background: none; border: none; }
        html.dark .control-icon {color:var(--text-color);} html.dark .control-icon:hover {color:var(--input-placeholder);}

        #quickMonthChangeBtn { border: none; background: none; padding: 0; margin: 0; font-size: 1.2em; cursor: pointer; color: var(--primary-color); }
        #quickMonthChangeBtn:hover { color: var(--link-color); }
        html.dark #quickMonthChangeBtn {color:var(--primary-color-dark);} html.dark #quickMonthChangeBtn:hover {color:var(--link-color);}

        .current-day-row { background-color: var(--current-day-bg); }

        #reminderArea {
             margin-top: 10px; padding: 8px;
             background-color: var(--reminder-bg); color: var(--reminder-text);
             border-radius: 4px; font-size: 0.9em; display: none;
         }
         hr { border-color: var(--border-color); }

        .friday-row { background-color: var(--friday-bg-light); }
        .friday-row td { border-color: var(--friday-border-light) !important; }
        .sunday-row { background-color: var(--sunday-bg-light); }
        .sunday-row td { border-color: var(--sunday-border-light) !important; }

        html.dark .friday-row { background-color: var(--friday-bg-dark); }
        html.dark .friday-row td { border-color: var(--friday-border-dark) !important; }
        html.dark .sunday-row { background-color: var(--sunday-bg-dark); }
        html.dark .sunday-row td { border-color: var(--sunday-border-dark) !important; }

        .current-day-row.friday-row,
        .current-day-row.sunday-row {
            background-color: var(--current-day-bg) !important;
        }

        #saveStatusIndicator {
            position: fixed; top: 10px; right: 10px;
            padding: 5px 10px; border-radius: 4px;
            font-size: 0.9em; z-index: 2000;
            display: none;
            transition: opacity 0.5s ease-out, background-color 0.3s ease;
            background-color: var(--save-success-bg);
            color: var(--save-text-color);
        }
        #saveStatusIndicator.saving {
            background-color: var(--save-saving-bg);
            color: var(--text-color);
        }
        html.dark #saveStatusIndicator.saving {
            color: var(--background-color);
        }
        #saveStatusIndicator.error {
            background-color: var(--save-error-bg);
        }

        tfoot tr td {
            font-weight: bold;
            background-color: var(--table-header-bg);
            color: var(--text-color);
        }
        html.dark tfoot tr td {
            background-color: var(--table-header-bg);
            color: var(--text-color);
        }


/* --- FILE 1 STYLE FOR TABLE (Paste this at the bottom of CSS) --- */

/* 1. ‡§á‡§®‡§™‡•Å‡§ü ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡§æ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§î‡§∞ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§π‡§ü‡§æ‡§®‡§æ (Seamless Look) */
td input {
    background-color: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    width: 100% !important;
    height: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
    text-align: center;
    display: block;
    border-radius: 0 !important;
    font-size: 15px; /* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§´‡•ã‡§Ç‡§ü ‡§¨‡§°‡§º‡§æ */
    color: inherit;
}

/* ‡§ú‡§ø‡§∏ ‡§ñ‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§π‡•ã, ‡§µ‡§π ‡§π‡§æ‡§à‡§≤‡§æ‡§á‡§ü ‡§π‡•ã */
td:focus-within {
    background-color: rgba(0, 123, 255, 0.15) !important;
    box-shadow: inset 0 0 0 2px var(--primary-color) !important;
}

/* 2. Absent (A) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§æ‡§≤ ‡§∞‡§Ç‡§ó */
.status-cell-absent {
    background-color: #ffebee !important;
    color: #d32f2f !important;
}
.status-cell-absent input {
    color: #d32f2f !important;
    font-weight: bold;
}

/* 3. Sunday ‡§ï‡§æ ‡§≤‡§æ‡§≤ ‡§∞‡§Ç‡§ó ‡§π‡§ü‡§æ‡§®‡§æ (Normal Look) */
.sunday-row, html.dark .sunday-row {
    background-color: transparent !important;
}
.sunday-row td, html.dark .sunday-row td {
    border-color: var(--border-color) !important;
}

/* 4. ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§µ‡•ç‡§Ø‡•Ç (Sticky Date & Compact Columns) */
@media (max-width: 768px) {
    /* ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•â‡§≤‡§Æ ‡§ï‡•ã ‡§ö‡§ø‡§™‡§ï‡§æ‡§è‡§Ç (Sticky) */
    th:nth-child(1), td:nth-child(1) {
        width: 75px !important;
        min-width: 75px !important;
        max-width: 75px !important;
        position: sticky;
        left: 0;
        z-index: 10;
        background-color: var(--container-bg-color);
        border-right: 2px solid #bbb;
        font-size: 11px !important;
        white-space: normal !important;
        line-height: 1.2;
    }
    html.dark th:first-child, html.dark td:first-child {
        background-color: var(--container-bg-color);
    }

    /* Status ‡§î‡§∞ OT ‡§ï‡•ã ‡§õ‡•ã‡§ü‡§æ ‡§ï‡§∞‡•á‡§Ç */
    th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3) {
        width: 30px !important;
        min-width: 30px !important;
        padding: 0 !important;
    }

    /* Notes ‡§ï‡•â‡§≤‡§Æ ‡§ï‡•ã ‡§õ‡•ã‡§ü‡§æ ‡§Ü‡§á‡§ï‡§® ‡§¨‡§®‡§æ‡§è‡§Ç */
    th:nth-child(7), td:nth-child(7) {
        display: table-cell !important;
        width: 40px !important;
        min-width: 40px !important;
        padding: 0 !important;
    }
    /* ‡§®‡•ã‡§ü‡•ç‡§∏ ‡§ï‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§õ‡§ø‡§™‡§æ‡§è‡§Ç */
    td:nth-child(7) .note-preview {
        display: none !important;
    }
    /* ‡§™‡•á‡§Ç‡§∏‡§ø‡§≤ ‡§Ü‡§á‡§ï‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç */
    td:nth-child(7)::after {
        content: 'üìù';
        font-size: 16px;
        opacity: 0.6;
        display: block;
        text-align: center;
    }

    /* Edited ‡§ï‡•â‡§≤‡§Æ ‡§•‡•ã‡§°‡§º‡§æ ‡§õ‡•ã‡§ü‡§æ */
    th:nth-child(8), td:nth-child(8) {
        width: 50px !important;
        min-width: 50px !important;
    }
    .edited-datetime-cell {
        font-size: 8px !important;
    }
    .edited-date-input, .edited-time-input {
        font-size: 8px !important;
    }
}





/* --- MOBILE VIEW FIX (Paste at bottom of CSS) --- */
@media (max-width: 768px) {
    
    /* 1. Notes (7‡§µ‡§æ‡§Ç) ‡§ï‡•â‡§≤‡§Æ ‡§ï‡•Ä ‡§ö‡•å‡§°‡§º‡§æ‡§à ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç */
    th:nth-child(7), td:nth-child(7) {
        display: table-cell !important;
        width: 45px !important;       /* ‡§ï‡•â‡§≤‡§Æ ‡§õ‡•ã‡§ü‡§æ ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
        min-width: 45px !important;
        max-width: 45px !important;
        padding: 0 !important;
        vertical-align: middle !important;
    }

    /* 2. ‡§Ü‡§á‡§ï‡§® ‡§π‡§ü‡§æ‡§è‡§Ç (Remove Pencil Icon) */
    td:nth-child(7)::after {
        content: none !important;     /* ‡§Ø‡§π ‡§≤‡§æ‡§á‡§® ‡§Ü‡§á‡§ï‡§® ‡§π‡§ü‡§æ‡§§‡•Ä ‡§π‡•à */
        display: none !important;
    }

    /* 3. ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç (Show Text Preview) */
    td:nth-child(7) .note-preview {
        display: block !important;    /* ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§µ‡§æ‡§™‡§∏ ‡§≤‡§æ‡§è‡§Ç */
        font-size: 9px !important;    /* ‡§´‡•ã‡§Ç‡§ü ‡§õ‡•ã‡§ü‡§æ ‡§∞‡§ñ‡•á‡§Ç */
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important; /* ‡§Ö‡§ó‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≤‡§Ç‡§¨‡§æ ‡§π‡•à ‡§§‡•ã ... ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç */
        text-align: center;
        width: 100%;
        color: var(--text-color);
        opacity: 0.7;
    }

    /* 4. ‡§¨‡§æ‡§ï‡•Ä ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡§ø‡§™‡§ï‡•Ä ‡§∞‡§π‡•á) */
    th:nth-child(1), td:nth-child(1) {
        position: sticky;
        left: 0;
        z-index: 10;
        background-color: var(--container-bg-color);
        border-right: 2px solid #bbb;
        width: 75px !important;
        min-width: 75px !important;
    }
    html.dark th:first-child, html.dark td:first-child {
        background-color: var(--container-bg-color);
    }
    
    /* 5. Edited ‡§ï‡•â‡§≤‡§Æ (8‡§µ‡§æ‡§Ç) ‡§õ‡•ã‡§ü‡§æ ‡§∞‡§ñ‡•á‡§Ç */
    th:nth-child(8), td:nth-child(8) {
        display: table-cell !important;
        width: 50px !important;
        min-width: 50px !important;
    }
}




/* --- DESIGN 1: BILL / LEDGER STYLE --- */
.bill-container {
    display: flex;
    flex-wrap: wrap;
    background: var(--container-bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-top: 10px;
    font-family: 'Courier New', Courier, monospace; /* ‡§¨‡§ø‡§≤ ‡§ú‡•à‡§∏‡§æ ‡§´‡•ã‡§Ç‡§ü */
}

.bill-col {
    flex: 1;
    min-width: 300px; /* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§ä‡§™‡§∞-‡§®‡•Ä‡§ö‡•á ‡§Ü‡§è‡§ó‡§æ */
    padding: 15px;
    border-right: 1px dashed var(--border-color);
}
.bill-col:last-child { border-right: none; }

.bill-header {
    font-size: 16px;
    font-weight: bold;
    text-transform: uppercase;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 8px;
    margin-bottom: 12px;
    letter-spacing: 1px;
}

.bill-row {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px dotted var(--border-color);
}
/* ‡§ü‡•ã‡§ü‡§≤ ‡§µ‡§æ‡§≤‡•Ä ‡§≤‡§æ‡§á‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ */
.bill-row.total-row {
    border-top: 1px solid var(--text-color);
    border-bottom: none;
    margin-top: 15px;
    padding-top: 5px;
    font-weight: bold;
    font-size: 15px;
}

.bill-footer {
    width: 100%;
    background: var(--primary-color);
    color: #fff;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: bold;
}
html.dark .bill-footer { background: var(--primary-color-dark); color: #000; }

.text-green { color: #2e7d32; }
.text-red { color: #c62828; }
html.dark .text-green { color: #81c784; } /* ‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§≤‡•ç‡§ï‡§æ ‡§π‡§∞‡§æ */
html.dark .text-red { color: #e57373; }   /* ‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§≤‡•ç‡§ï‡§æ ‡§≤‡§æ‡§≤ */





    </style>
</head>
<body class="">
<!-- 1. ‡§≤‡•â‡§ó‡§ø‡§® ‡§¨‡•â‡§ï‡•ç‡§∏ (‡§®‡§Ø‡§æ) -->
<div id="authBox" style="max-width:400px; margin:50px auto; text-align:center; padding:20px; border:1px solid #ddd; border-radius:10px; background:white;">
    <h2>Attendance Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" style="width:90%; padding:10px; margin:10px 0;">
    <input type="password" id="loginPass" placeholder="Password" style="width:90%; padding:10px; margin:10px 0;">
    <button onclick="handleAuth('login')" style="width:95%; padding:10px; background:#007bff; color:white; border:none;">Login</button>
    <button id="signupBtn" onclick="handleAuth('signup')" style="width:95%; padding:10px; background:#28a745; color:white; border:none; margin-top:10px;">Signup (Admin Only)</button>
    <p id="inviteMsg" style="color:blue; font-weight:bold; margin-top:15px;"></p>
</div>

<!-- 2. ‡§Ü‡§™‡§ï‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§ê‡§™ ‡§ï‡•ã ‡§á‡§∏ "mainAppWrapper" ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç -->
<div id="mainAppWrapper" class="hidden">
    <!-- ‡§Ø‡§π‡§æ‡§Å ‡§ä‡§™‡§∞ ‡§è‡§ï ‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ ‡§¨‡§æ‡§∞ ‡§ú‡•ã‡•ú‡•á‡§Ç -->
    <div style="background:#333; color:white; padding:10px; display:flex; justify-content:space-between;">
        <span id="userDisplay"></span>
        <button onclick="auth.signOut().then(()=>location.reload())" style="color:white; border:1px solid white; background:none;">Logout</button>
    </div>
    
    <div id="invitePanel" class="hidden" style="background:#eee; padding:10px;">
        <b>Invite Team:</b>
        <button onclick="generateInvite('super')" id="btnInvSuper">Invite Super User</button>
        <button onclick="generateInvite('user')">Invite User</button>
    </div>

    <!-- ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§Ü‡§™‡§ï‡•Ä ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§´‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ ‡§Ö‡§∏‡§≤‡•Ä ‡§∏‡§æ‡§Æ‡§æ‡§® (controlsHeader, reportArea ‡§Ü‡§¶‡§ø) ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§ó‡§æ -->
    <div id="saveStatusIndicator"></div>

     <div id="controlsHeader">
         <h1 id="appTitle" data-translate-key="appTitle">Attendance Tracker</h1>
         <div id="topControls">
             <button id="languageToggleBtn" onclick="toggleLanguage()" class="control-icon" data-translate-key-title="Change Language / ‡§≠‡§æ‡§∑‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç">
                 <i class="fas fa-language"></i> <span id="currentLangDisplay"></span>
             </button>
             <button id="darkModeToggleBtn" onclick="toggleDarkMode()" class="control-icon" data-translate-key-title="Toggle Dark Mode / ‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§° ‡§ü‡•â‡§ó‡§≤ ‡§ï‡§∞‡•á‡§Ç">
                 <i class="fas fa-moon"></i>
             </button>
             <button id="modeToggleBtn" onclick="toggleCalculationMode()" class="control-icon" data-translate-key-title="toggleCalculationModeTitle">
                <span id="modeIcon">üìÖ</span>
             </button>
             <button id="hideUsersBtn" onclick="toggleUsers()">
                 <span data-translate-key="hideShowNames">Hide/Show Names</span>
             </button>
             <button id="toggleDataManagementBtn" onclick="toggleDataMenu()" class="control-icon" data-translate-key-title="Data Management Options / ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™">
                 <i class="fas fa-database"></i> </button>
         </div>
     </div>

    <div id="addUserInputContainer" class="container">
         <input type="text" id="newUserName" data-translate-key-placeholder="addNewNamePlaceholder" placeholder="Add New Name" style="flex-grow: 1;"> <button id="addUserBtn" onclick="addUser()">
            <span style="font-size: 20px;">‚ûï</span>
         </button>
    </div>

    <div id="userTabs"></div>
    <div id="reminderArea"></div> <div id="dataManagementButtons"> <button id="exportDataBtn" onclick="exportData()" >
            <i class="fas fa-download"></i> <span data-translate-key="exportData">Export Data (JSON)</span>
        </button>
        <button id="importDataBtn" onclick="document.getElementById('importFileInput').click()" >
            <i class="fas fa-upload"></i> <span data-translate-key="importData">Import Data (JSON)</span>
        </button>
        <input type="file" id="importFileInput" accept=".json" onchange="handleFileUpload(event)" style="display:none;">
        <button id="clearAllBalancesBtn" onclick="clearAllCarriedBalances()">
            <i class="fas fa-eraser"></i> <span data-translate-key="clearAllBalances">Clear ALL Carried Balances</span>
        </button>
        <button id="clearDataBtn" onclick="clearAllData()" >
            <i class="fas fa-trash-alt"></i> <span data-translate-key="clearAllData">Clear All Data</span>
        </button>
        <button id="archiveUserBtn" onclick="toggleArchiveCurrentUser()" style="display: none;"></button> <button id="toggleArchivedUsersBtn" onclick="toggleArchivedUsers()" style="display: none;"></button> </div>

    <div id="importPreviewModal" class="modal">
        <div class="modal-content"> <div class="modal-header"> <span class="modal-title" data-translate-key="importPreviewTitle">Import Data Preview</span>
                <span class="close-button" onclick="closeImportModal()">&times;</span> </div>
            <div class="modal-body" id="importPreviewContent"></div>
            <div class="modal-footer">
                <button onclick="closeImportModal()" data-translate-key="cancel">Cancel</button>
                <button onclick="confirmImport('merge')" data-translate-key="mergeData">Merge Data</button>
                <button onclick="confirmImport('replace')" data-translate-key="replaceAllData">Replace All Data</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <span class="modal-title" data-translate-key="notesModalTitle">View/Edit Note</span>
                <span class="close-button" onclick="closeNotesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <textarea id="modalNoteTextarea" rows="6" data-translate-key-placeholder="notesPlaceholder"></textarea>
                <input type="hidden" id="modalNoteMonthKey">
                <input type="hidden" id="modalNoteDayIndex">
            </div>
            <div class="modal-footer">
                <button onclick="closeNotesModal()" data-translate-key="cancel">Cancel</button>
                <button onclick="saveModalNote()" id="saveNoteModalBtn" data-translate-key="saveNote">Save Note</button>
            </div>
        </div>
    </div>


    <div id="userControl"> <div> <h2 style="margin: 0;"><span data-translate-key="forUser">‡§ï‡•á ‡§≤‡§ø‡§è</span> <span id="selectedUserName"></span></h2>
        </div>

        <div id="userQuickControls">
             <div id="rateContainer">
                 <label for="userRate" data-translate-key="rateLabel">Rate (Per Attendance):</label>
                 <input type="number" id="userRate" step="any" min="0" data-translate-key-placeholder="ratePlaceholderShort" placeholder="Rate">
             </div>

             <div id="overtimeRateContainer">
                 <label for="userOvertimeRate" data-translate-key="overtimeRateLabel">Overtime Hours per Attendance Rate:</label>
                 <input type="number" id="userOvertimeRate" step="any" min="1" data-translate-key-placeholder="otRatePlaceholderShort" placeholder="OT Rate">
             </div>

              <div id="manualBalanceContainer">
                 <label for="manualCarriedOverBalance" data-translate-key="manualBalanceLabel">Carried Over Balance:</label>
                 <input type="number" id="manualCarriedOverBalance" step="any" data-translate-key-placeholder="balancePlaceholderShort" placeholder="Previous Balance">
              </div>

              <div id="includeBalanceContainer">
                  <label for="otherUserForReport" data-translate-key="includeBalanceOf">Include Balance of:</label>
                  <select id="otherUserForReport" onchange="showSummary()">
                      <option value="" selected disabled hidden data-translate-key="selectUserPlaceholderShort">-- User --</option>
                      </select>
              </div>
         </div>


        <div id="monthNavWrapper">
            <div id="monthNav">
                <button onclick="goToPreviousPeriod()">‚ùÆ <span data-translate-key="previous">Previous</span></button>
                <div class="month-display-group">
                    <span id="currentMonthDisplay"></span>
                    <button id="quickMonthChangeBtn" onclick="promptQuickPeriodChange()" title="Quick Change Period">‚ö°</button>
                </div>
                <button onclick="goToNextPeriod()"><span data-translate-key="next">Next</span> ‚ùØ</button>
            </div>
        </div>

        <div id="viewReportButtonsWrapper" style="margin-top: 15px; margin-bottom: 10px;">
            <button id="viewOverallReportBtn" data-translate-key="viewOverallReport" onclick="displayOverallReport()" style="width:100%;">View Overall Report</button>
        </div>


         
<div id="shareReportButtonWrapper" style="display: flex; flex-direction: column; gap: 8px;">
    <!-- ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏: ‡§á‡§Æ‡•á‡§ú ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ ‡§π‡•à -->
    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; background: var(--input-bg); padding: 5px; border: 1px solid var(--border-color); border-radius: 4px;">
        <label style="font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 5px;">
            <!-- Notes ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ü‡§ø‡§ï ‡§∞‡§π‡•á‡§ó‡§æ -->
            <input type="checkbox" id="includeNotesInShare" checked> 
            <span data-translate-key="includeNotesOption">Include Notes</span>
        </label>
        <label style="font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 5px;">
            <!-- Edited ‡§µ‡§æ‡§≤‡§æ ‡§Ö‡§¨ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ü‡§ø‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§∞‡§π‡•á‡§ó‡§æ (Hidden by default) -->
            <input type="checkbox" id="includeEditedInShare"> 
            <span data-translate-key="includeEditedOption">Include Edited Info</span>
        </label>
    </div>

    <button onclick="shareReport()" style="width:100%;">
        <span data-translate-key="shareReportImage">Share Report (Image)</span>
    </button>
</div>


    <button onclick="shareReport()" style="width:100%;">
        <span data-translate-key="shareReportImage">Share Report (Image)</span>
    </button>
</div>

     <div id="reportArea">
         <div id="tableContainer"></div>
         <div id="previousBalancePaymentsSection"> <h3 data-translate-key="prevBalancePaymentsTitle">Payments Received Towards Previous Balance</h3>
             <div id="paymentList"></div>
             <div id="addPaymentForm">
                  <label for="paymentAmount" data-translate-key="amountLabel">Amount:</label>
                  <input type="number" id="paymentAmount" step="any" data-translate-key-placeholder="amountPlaceholder" placeholder="Amount">
                  <label for="paymentDate" data-translate-key="dateLabel">Date:</label>
                  <input type="date" id="paymentDate">
                  <label for="paymentNotes" data-translate-key="notesLabel">Notes:</label>
                  <input type="text" id="paymentNotes" data-translate-key-placeholder="notesPlaceholder" placeholder="Notes">
                  <button onclick="addPreviousBalancePayment()"><span data-translate-key="addPayment">Add Payment</span></button>
             </div>
        </div>

         <div id="overallSummarySection" style="display: none;"></div>

         <div id="summarySection"> </div>

        <div id="reportFooter"> </div>
    </div>

    <script>





const firebaseConfig = {
    apiKey: "AIzaSyCFZL-_arIus7bnA4U9kKw0uhIet6Ng3SU",
    authDomain: "my-attendance-795fa.firebaseapp.com",
    projectId: "my-attendance-795fa",
    storageBucket: "my-attendance-795fa.firebasestorage.app",
    messagingSenderId: "462347673756",
    appId: "1:462347673756:web:bd69375de1db201b550d59",
    measurementId: "G-B03E17HG43"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let loggedInUser = null;
let masterAdminId = null;

// ‡§≤‡§ø‡§Ç‡§ï ‡§ö‡•á‡§ï ‡§ï‡§∞‡§®‡§æ
const params = new URLSearchParams(window.location.search);
const inviteRole = params.get('role');
const refId = params.get('ref');

if(inviteRole) document.getElementById('inviteMsg').innerText = "Joining as: " + inviteRole.toUpperCase();

async function handleAuth(type) {
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPass').value;
    try {
        if(type === 'signup') {
            const res = await auth.createUserWithEmailAndPassword(email, pass);
            await db.collection("users").doc(res.user.uid).set({
                email, role: inviteRole || 'admin', adminId: refId || res.user.uid, invitedBy: params.get('by') || 'admin'
            });
        } else { await auth.signInWithEmailAndPassword(email, pass); }
    } catch(e) { alert(e.message); }
}

auth.onAuthStateChanged(async (user) => {
    if(user) {
        const doc = await db.collection("users").doc(user.uid).get();
        loggedInUser = doc.data();
        masterAdminId = loggedInUser.adminId;
        
        document.getElementById('authBox').classList.add('hidden');
        document.getElementById('mainAppWrapper').classList.remove('hidden');
        document.getElementById('userDisplay').innerText = user.email + " (" + loggedInUser.role + ")";
        
        // ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§∏‡•á ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞
        if(loggedInUser.role === 'admin') document.getElementById('invitePanel').classList.remove('hidden');
        
        // ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§°‡•á‡§ü‡§æ ‡§∏‡•Å‡§®‡§®‡§æ (Real-time sync)
        db.collection("attendance").doc(masterAdminId).onSnapshot((doc) => {
            if(doc.exists) {
                data = doc.data().attendanceData || {};
                // ‡§Ü‡§™‡§ï‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á render functions ‡§ï‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§π‡•à
                if(typeof renderUserTabs === 'function') renderUserTabs();
                if(typeof fullRender === 'function') fullRender();
            }
        });
    }
});

function generateInvite(role) {
    const link = `${window.location.origin}${window.location.pathname}?ref=${masterAdminId}&role=${role}&by=${auth.currentUser.uid}`;
    window.open(`https://wa.me/?text=Join Team: ${encodeURIComponent(link)}`);
}



        // --- Configuration ---
        const translations = {
             'en': {
                appTitle: "Attendance Tracker", hideShowNames: "Hide/Show Names", dataManagement: "Data Management",
                 dataManagementOptions: "Data Management Options", exportData: "Export Data (JSON)", importData: "Data Import (JSON)",
                 clearAllData: "Clear All Data", forUser: "For", previous: "Previous", next: "Next",
                 toggleCalculationModeTitle: "Toggle between Full Month and Half Month mode",
                 fullMonthMode: "Full Month Mode", halfMonthMode: "Half Month Mode",
                 shareReportImage: "Share Report (Image)", prevBalancePaymentsTitle: "Payments Received Towards Previous Balance",
                 amountLabel: "Amount:", dateLabel: "Date:", notesLabel: "Notes:", addPayment: "Add Payment",
                 cancel: "Cancel", mergeData: "Merge Data", replaceAllData: "Replace All Data", attendanceHeader: "Attendance",
                 expensesHeader: "Expenses", rent: "Rent", food: "Food", received: "Received (Daily)", balance: "Balance",
                 addNewNamePlaceholder: "Add New Name", notesPlaceholder: "Notes", amountPlaceholder: "Amount",
                 promptMonthInput: "Enter Period (YYYY-MM for Full, YYYY-MM_1 for 1-15, YYYY-MM_2 for 16-End):",
                 dateHeaderTbl: "Date", statusHeaderTbl: "Status", otHeaderTbl: "OT", rentHeaderTbl: "Rent", foodHeaderTbl: "Food", receivedHeaderTbl: "Received", notesHeaderTbl: "Notes", editedHeaderTbl: "Edited",
                 alertEnterName: "Please enter a name.", alertUserExists: "User '{name}' already exists (case-insensitive match)! Do you want to reactivate them?",
                 alertUserAdded: "User '{name}' added successfully!", alertSelectUserMonth: "Please select a user and period first.",
                 alertEnterValidAmount: "Please enter a valid positive amount.", alertPaymentAdded: "Payment added.", alertPaymentDeleted: "Payment deleted.",
                 confirmDeletePayment: "Are you sure you want to delete this payment of {amount}?",
                 alertGenerateReportFirst: "Please generate a report first.",
                 alertCannotGenerateImage: "Cannot generate report image without a selected user, period, or table data.",
                 alertWebShareFailed: "Sharing failed directly. Report image downloaded instead.", alertWebShareCancelled: "Web Share cancelled by user.",
                 alertImageDownloaded: "Report image generated. It should be downloaded to your device.", alertCouldNotGenerateImage: "Could not generate report image.",
                 confirmClearData: "Are you sure you want to delete ALL user data? This action cannot be undone.",
                 alertDataCleared: "All data has been cleared.", alertDataExported: "Data exported successfully! Your backup file is being downloaded.",
                 alertExportFailed: "Failed to export data. Error: {error}", alertNoFileSelected: "No file selected.",
                 alertSelectJsonFile: "Please select a JSON file.", alertImportProcessingError: "Failed to process import file: {error}",
                 alertFileReadError: "Error reading file.", alertInvalidImportFormat: "Invalid data format. Missing attendanceData object.",
                 alertNoImportData: "No import data available.", alertDataImported: "Data {mode} successfully!",
                 alertImportFailed: "Failed to import data: {error}", importPreviewTitle: "Data Import Preview",
                 importContainsUsers: "This data file contains information for <strong>{count}</strong> users:",
                 andMoreUsers: "...and {count} more users", currentData: "Current Data:",
                 youHaveUsers: "You currently have <strong>{count}</strong> users in your system.",
                 importChooseOption: "Please choose how to import this data:",
                 importOptionMerge: "Merge Data: Add new users and update existing ones",
                 importOptionReplace: "Replace All: Delete all current data and replace with imported data",
                 reportFor: "Report for {user} - {title}",
                 attendanceSummary: "Attendance: {days} days √ó {rate} = {total}",
                 overtimeSummary: "Overtime: {hours} hours ‚Üí {amount} ({hoursPerDay} hours equals 1 Attendance Rate)",
                 rentSummary: "Rent: {amount}", foodSummary: "Food: {amount}", currentPeriodGross: "Current Period Gross Total: {amount}",
                 carriedOverBalance: "Carried Over Balance: {amount}",
                 manualBalanceLabel: "Carried Over Balance:", manualBalancePlaceholder: "Enter Previous Balance",
                 totalOwed: "Total Amount Owed (Gross + Carried Over Balance): {amount}",
                 totalReceivedDaily: "Total Received (Daily Entries this Period): {amount}",
                 totalReceivedPrevBalance: "Total Received (Towards Previous Balance this Period): {amount}",
                 totalAllReceived: "Total ALL Received (This Period): {amount}",
                 finalBalanceDueForPeriod: "Final Balance Due (for this Period): {amount}",
                 reportTitleFull: "{year} {month}",
                 reportTitleFirstHalf: "{year} {month} (1-15)",
                 reportTitleSecondHalf: "{year} {month} (16-End)",
                 reportGeneratedOn: "Report for {user} ({periodTitle}) - Generated on {dateTime}\nFinal Balance Due: {balance}{otherUserBalanceString}",
                 reminderFinalize: "Month is ending soon. Remember to finalize reports.",
                 noPaymentsRecorded: "no payments recorded for this period.", noDataForMonth: "No or invalid data structure available for {monthKey}.",
                 pleaseSelectUser: "Please select a user first.", errorInvalidMonthKey: "Error: Invalid month data key \"{monthKey}\".",
                 invalidMonth: "Invalid Month", alertInvalidPeriodFormat: "Invalid period format. Use YYYY-MM, YYYY-MM_1, or YYYY-MM_2.",
                 alertInvalidDateTimeFormat: "Invalid date/time format. Please use DD-MM-YYYY and HH:MM or leave empty.",
                 alertMonthDoesNotExist: "No data available for month {monthKey}.", noDate: "No Date/Time", autoSaveStatus: "Auto-saved: {time}",
                 confirmArchiveUser: "Are you sure you want to archive user '{name}'? Their data will be saved but they won't appear in the main list until you click 'Show Archived Users'.",
                 alertUserArchived: "User '{name}' has been archived. You can see them by clicking 'Show Archived Users'.",
                 confirmReactivateUser: "User '{name}' is currently archived. Do you want to reactivate them?",
                 alertUserReactivated: "User '{name}' has been reactivated.", showOptions: "Show Options", hideOptions: "Hide Options",
                 showArchived: "Show Archived", hideArchived: "Hide Archived", archiveUser: "Archive User", reactivateUser: "Reactivate User",
                 cannotGoToFutureMonth: "Cannot navigate to a future period relative to the current system date.",
                 confirmCarryOverBalance: "Do you want to carry over the balance of {amount} to the period {period}?",
                 viewOverallReport: "View Overall Report", overallReportTitle: "Overall Report for {user}",
                 overallAttendanceSummary: "Total Attendance Days: {days}", overallOvertimeSummary: "Total Overtime Hours: {hours}",
                 overallRentSummary: "Total Rent: {amount}", overallFoodSummary: "Total Food: {amount}",
                 overallDailyReceivedSummary: "Total Daily Received: {amount}", overallPrevBalPaymentsSummary: "Total Received Towards Previous Balance: {amount}",
                 overallGrossSummary: "Total Gross Earnings: {amount}", initialCarriedOverBalanceSummary: "Initial Carried Over Balance (from {month}): {amount}",
                 overallFinalBalanceDue: "Overall Final Balance Due: {amount}", noDataForOverallReport: "No data available to generate overall report for {user}.",
                 includeBalanceOf: "Include Balance of:", otherUserPeriodEarnings: "Period Earnings for {otherUser}: {amount}",
                 otherUserPeriodReceived: "Period Received (Daily) for {otherUser}: {amount}", otherUserPeriodNet: "Period Net for {otherUser} ({earnings} - {received}): {amount}",
                 otherUserFinalBalance: "Final Balance Due for {otherUser}: {amount}", combinedFinalBalance: "Combined Final Balance Due ({currentUser} + {otherUser}'s Final Balance): {amount}",
                 footerIncludeOtherUserFinalBalance: "\n({otherUser}'s Final Balance included: {otherUserFinalBalance}) \nCombined Balance: {combinedBalance}",
                 overtimeRateLabel: "Overtime Hours per Attendance Rate:", otRatePlaceholder: "OT Rate", selectUserPlaceholder: "-- Select User --",
                 ratePlaceholderShort: "Rate", otRatePlaceholderShort: "OT", balancePlaceholderShort: "Bal", selectUserPlaceholderShort: "-- User --",
                 editedDatePlaceholder: "DD-MM-YYYY", editedTimePlaceholder: "HH:MM",
                 notesModalTitle: "View/Edit Note", saveNote: "Save Note", totalLabel: "Total",
                 alertPaymentDateRequired: "Please select a date for the payment.",
                 carriedOverBalanceFromPrevMonth: "Carried Over Balance (from Previous Month): {amount}",
                 carriedOverBalanceFromPrevPeriod: "Carried Over Balance (from 1-15 Period): {amount}",
                 clearAllBalances: "Clear ALL Carried Balances",
                 confirmClearBalances: "Are you sure? This will reset the 'Carried Over Balance' to 0 for ALL users and ALL past months. This cannot be undone.",

       includeNotesOption: "Include Notes",
includeEditedOption: "Include Edited Info",
                 alertBalancesCleared: "All carried over balances have been cleared successfully!"
            },
             'hi': {
                appTitle: "‡§π‡§æ‡§ú‡§º‡§ø‡§∞‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï‡§∞", hideShowNames: "‡§®‡§æ‡§Æ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å/‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å", dataManagement: "‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®",
                 dataManagementOptions: "‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™", exportData: "‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç (JSON)", importData: "‡§°‡•á‡§ü‡§æ ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç (JSON)",
                 clearAllData: "‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç", forUser: "‡§ï‡•á ‡§≤‡§ø‡§è", previous: "‡§™‡§ø‡§õ‡§≤‡§æ", next: "‡§Ö‡§ó‡§≤‡§æ",
                 toggleCalculationModeTitle: "‡§´‡•Å‡§≤ ‡§Æ‡§Ç‡§• ‡§î‡§∞ ‡§π‡§æ‡§´ ‡§Æ‡§Ç‡§• ‡§Æ‡•ã‡§° ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§∏‡•ç‡§µ‡§ø‡§ö ‡§ï‡§∞‡•á‡§Ç",
                 fullMonthMode: "‡§´‡•Å‡§≤ ‡§Æ‡§Ç‡§• ‡§Æ‡•ã‡§°", halfMonthMode: "‡§π‡§æ‡§´ ‡§Æ‡§Ç‡§• ‡§Æ‡•ã‡§°",
                 shareReportImage: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç (‡§á‡§Æ‡•á‡§ú)", prevBalancePaymentsTitle: "‡§™‡§ø‡§õ‡§≤‡•á ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®",
                 amountLabel: "‡§∞‡§æ‡§∂‡§ø:", dateLabel: "‡§§‡§æ‡§∞‡•Ä‡§ñ:", notesLabel: "‡§ü‡§ø‡§™‡•ç‡§™‡§£‡§ø‡§Ø‡§æ‡§Å:", addPayment: "‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
                 cancel: "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç", mergeData: "‡§°‡•á‡§ü‡§æ ‡§Æ‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", replaceAllData: "‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç", attendanceHeader: "‡§π‡§æ‡§ú‡§º‡§ø‡§∞‡•Ä",
                 expensesHeader: "‡§ñ‡§∞‡•ç‡§ö", rent: "‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ", food: "‡§ñ‡§æ‡§®‡§æ", received: "‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ (‡§∞‡•ã‡§ú‡§æ‡§®‡§æ)", balance: "‡§¨‡•à‡§≤‡•á‡§Ç‡§∏",
                 addNewNamePlaceholder: "‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç", notesPlaceholder: "‡§ü‡§ø‡§™‡•ç‡§™‡§£‡§ø‡§Ø‡§æ‡§Å", amountPlaceholder: "‡§∞‡§æ‡§∂‡§ø",
                 promptMonthInput: "‡§Ö‡§µ‡§ß‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (YYYY-MM ‡§´‡•Å‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è, YYYY-MM_1 1-15 ‡§ï‡•á ‡§≤‡§ø‡§è, YYYY-MM_2 16-‡§Ö‡§Ç‡§§ ‡§ï‡•á ‡§≤‡§ø‡§è):",
                 dateHeaderTbl: "‡§§‡§æ‡§∞‡•Ä‡§ñ", statusHeaderTbl: "‡§∏‡•ç‡§•‡§ø‡§§‡§ø", otHeaderTbl: "‡§ì‡§ü‡•Ä", rentHeaderTbl: "‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ", foodHeaderTbl: "‡§ñ‡§æ‡§®‡§æ", receivedHeaderTbl: "‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§", notesHeaderTbl: "‡§ü‡§ø‡§™‡•ç‡§™‡§£‡§ø‡§Ø‡§æ‡§Å", editedHeaderTbl: "‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§",
                 alertEnterName: " ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§", alertUserExists: "‡§Ø‡•Ç‡§ú‡§º‡§∞ '{name}' ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à! ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?",
                 alertUserAdded: "‡§Ø‡•Ç‡§ú‡§º‡§∞ '{name}' ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!", alertSelectUserMonth: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§î‡§∞ ‡§Ö‡§µ‡§ß‡§ø ‡§ö‡•Å‡§®‡•á‡§Ç‡•§",
                 alertEnterValidAmount: " ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡§ï‡§æ‡§∞‡§æ‡§§‡•ç‡§Æ‡§ï ‡§∞‡§æ‡§∂‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§", alertPaymentAdded: "‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§", alertPaymentDeleted: " ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§",
                 confirmDeletePayment: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™ {amount} ‡§ï‡§æ ‡§Ø‡§π ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?",
                 alertGenerateReportFirst: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§",
                 alertCannotGenerateImage: "‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è ‡§Ø‡•Ç‡§ú‡§º‡§∞, ‡§Ö‡§µ‡§ß‡§ø, ‡§Ø‡§æ ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§ï‡•á ‡§¨‡§ø‡§®‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§á‡§Æ‡•á‡§ú ‡§ú‡§®‡§∞‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§",
                 alertWebShareFailed: "‡§∏‡•Ä‡§ß‡§æ ‡§∂‡•á‡§Ø‡§∞ ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ‡•§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§á‡§Æ‡•á‡§ú ‡§á‡§∏‡§ï‡•á ‡§¨‡§ú‡§æ‡§Ø ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡•Ä ‡§ó‡§à‡•§", alertWebShareCancelled: "‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§µ‡•á‡§¨ ‡§∂‡•á‡§Ø‡§∞ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§",
                 alertImageDownloaded: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§á‡§Æ‡•á‡§ú ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡•Ä ‡§ó‡§à‡•§ ‡§á‡§∏‡•á ‡§Ü‡§™‡§ï‡•á ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§™‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§", alertCouldNotGenerateImage: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§á‡§Æ‡•á‡§ú ‡§ú‡§®‡§∞‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•Ä‡•§",
                 confirmClearData: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™ **‡§∏‡§æ‡§∞‡§æ** ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§",
                 alertDataCleared: "‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§", alertDataExported: "‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ! ‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§´‡§º‡§æ‡§á‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡•§",
                 alertExportFailed: "‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ: ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: {error}", alertNoFileSelected: "‡§ï‡•ã‡§à ‡§´‡§º‡§æ‡§á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§®‡•Ä ‡§ó‡§à‡•§",
                 alertSelectJsonFile: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", alertImportProcessingError: "‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ: {error}",
                 alertFileReadError: "‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡§¢‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§", alertInvalidImportFormat: "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™‡•§ attendanceData ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ó‡§æ‡§Ø‡§¨ ‡§π‡•à‡•§",
                 alertNoImportData: "‡§ï‡•ã‡§à ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", alertDataImported: "‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï {mode} ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!",
                 alertImportFailed: "‡§°‡•á‡§ü‡§æ ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ: ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: {error}", importPreviewTitle: "‡§°‡•á‡§ü‡§æ ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®",
                 importContainsUsers: "‡§á‡§∏ ‡§°‡•á‡§ü‡§æ ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç <strong>{count}</strong> ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§π‡•à:",
                 andMoreUsers: "...‡§î‡§∞ {count} ‡§Ö‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§ú‡§º‡§∞", currentData: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§°‡•á‡§ü‡§æ:",
                 youHaveUsers: "‡§Ü‡§™‡§ï‡•á ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§Æ‡•á‡§Ç ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç <strong>{count}</strong> ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§π‡•à‡§Ç‡•§",
                 importChooseOption: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§ï‡§ø ‡§á‡§∏ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§ï‡•à‡§∏‡•á ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç:",
                 importOptionMerge: "‡§°‡•á‡§ü‡§æ ‡§Æ‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç: ‡§®‡§è ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ‡§î‡§∞ ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç",
                 importOptionReplace: "‡§∏‡§¨ ‡§¨‡§¶‡§≤‡•á‡§Ç: ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§è‡§Å ‡§î‡§∞ ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è ‡§°‡•á‡§ü‡§æ ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç",
                 reportFor: "{user} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü - {title}",
                 attendanceSummary: "‡§π‡§æ‡§ú‡§º‡§ø‡§∞‡•Ä: {days} ‡§¶‡§ø‡§® √ó {rate} = {total}",
                 overtimeSummary: "‡§ì‡§µ‡§∞‡§ü‡§æ‡§á‡§Æ: {hours} ‡§ò‡§Ç‡§ü‡•á ‚Üí {amount} ({hoursPerDay} ‡§ò‡§Ç‡§ü‡•á 1 ‡§π‡§æ‡§ú‡§º‡§ø‡§∞‡•Ä ‡§¶‡§∞ ‡§ï‡•á ‡§¨‡§∞‡§æ‡§¨‡§∞)",
                 rentSummary: "‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ: {amount}", foodSummary: "‡§ñ‡§æ‡§®‡§æ: {amount}", currentPeriodGross: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Ö‡§µ‡§ß‡§ø ‡§ï‡§æ ‡§∏‡§ï‡§≤ ‡§Ø‡•ã‡§ó: {amount}",
                 carriedOverBalance: "‡§≤‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏: {amount}",
                 manualBalanceLabel: "‡§≤‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏:", manualBalancePlaceholder: "‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
                 totalOwed: "‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø (‡§∏‡§ï‡§≤ + ‡§≤‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏): {amount}",
                 totalReceivedDaily: "‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ (‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§ï‡•Ä ‡§∞‡•ã‡§ú‡§º‡§æ‡§®‡§æ ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø‡§Ø‡§æ‡§Å): {amount}",
                 totalReceivedPrevBalance: "‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ (‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§™‡§ø‡§õ‡§≤‡•á ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è): {amount}",
                 totalAllReceived: "‡§ï‡•Å‡§≤ ‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ (‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø): {amount}",
                 finalBalanceDueForPeriod: "‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¶‡•á‡§Ø ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è): {amount}",
                 reportTitleFull: "{year} {month}",
                 reportTitleFirstHalf: "{year} {month} (1-15)",
                 reportTitleSecondHalf: "{year} {month} (16-‡§Ö‡§Ç‡§§)",
                 reportGeneratedOn: "{user} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ({periodTitle}) - {dateTime} ‡§ï‡•ã ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡•Ä ‡§ó‡§à\n‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¶‡•á‡§Ø ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏: {balance}{otherUserBalanceString}",
                 reminderFinalize: "‡§Æ‡§π‡•Ä‡§®‡§æ ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§∞‡•Ç‡§™ ‡§¶‡•á‡§®‡§æ ‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•á‡§Ç‡•§",
                 noPaymentsRecorded: "‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§", noDataForMonth: "{monthKey} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Ø‡§æ ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§",
                 pleaseSelectUser: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", errorInvalidMonthKey: "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Æ‡§π‡•Ä‡§®‡§æ ‡§°‡•á‡§ü‡§æ ‡§ï‡•Å‡§Ç‡§ú‡•Ä \"{monthKey}\"‡•§",
                 invalidMonth: "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Æ‡§π‡•Ä‡§®‡§æ", alertInvalidPeriodFormat: "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ö‡§µ‡§ß‡§ø ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™‡•§ YYYY-MM, YYYY-MM_1, ‡§Ø‡§æ YYYY-MM_2 ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§",
                 alertInvalidDateTimeFormat: "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§§‡§æ‡§∞‡•Ä‡§ñ/‡§∏‡§Æ‡§Ø ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ DD-MM-YYYY ‡§î‡§∞ HH:MM ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º ‡§¶‡•á‡§Ç‡•§",
                 alertMonthDoesNotExist: "‡§Æ‡§π‡•Ä‡§®‡§æ {monthKey} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", noDate: "‡§ï‡•ã‡§à ‡§§‡§æ‡§∞‡•Ä‡§ñ/‡§∏‡§Æ‡§Ø ‡§®‡§π‡•Ä‡§Ç", autoSaveStatus: "‡§ë‡§ü‡•ã-‡§∏‡•á‡§µ ‡§π‡•Å‡§Ü: {time}",
                 confirmArchiveUser: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§Ø‡•Ç‡§ú‡§º‡§∞ '{name}' ‡§ï‡•ã ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ (archive) ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§â‡§®‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§π‡•á‡§ú‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ ‡§≤‡•á‡§ï‡§ø‡§® ‡§ú‡§¨ ‡§§‡§ï ‡§Ü‡§™ '‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å' ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡•á, ‡§µ‡•á ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•á‡§Ç‡§ó‡•á‡•§",
                 alertUserArchived: "‡§Ø‡•Ç‡§ú‡§º‡§∞ '{name}' ‡§ï‡•ã ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ü‡§™ ‡§â‡§®‡•ç‡§π‡•á‡§Ç '‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å' ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§",
                 confirmReactivateUser: "‡§Ø‡•Ç‡§ú‡§º‡§∞ '{name}' ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?",
                 alertUserReactivated: "‡§Ø‡•Ç‡§ú‡§º‡§∞ '{name}' ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§", showOptions: "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å", hideOptions: "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å",
                 showArchived: "‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å", hideArchived: "‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å", archiveUser: "‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç", reactivateUser: "‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç",
                 cannotGoToFutureMonth: "‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§ï‡•Ä ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§∏‡•á ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•Ä ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§§‡•á‡•§",
                 confirmCarryOverBalance: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ {amount} ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ {period} ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§≤‡•á ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?",
                 viewOverallReport: "‡§ï‡•Å‡§≤ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç", overallReportTitle: "{user} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•Å‡§≤ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü",
                 overallAttendanceSummary: "‡§ï‡•Å‡§≤ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§ø‡§®: {days}", overallOvertimeSummary: "‡§ï‡•Å‡§≤ ‡§ì‡§µ‡§∞‡§ü‡§æ‡§á‡§Æ ‡§ò‡§Ç‡§ü‡•á: {hours}",
                 overallRentSummary: "‡§ï‡•Å‡§≤ ‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ: {amount}", overallFoodSummary: "‡§ï‡•Å‡§≤ ‡§ñ‡§æ‡§®‡§æ: {amount}",
                 overallDailyReceivedSummary: "‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ (‡§∞‡•ã‡§ú‡§æ‡§®‡§æ): {amount}", overallPrevBalPaymentsSummary: "‡§™‡§ø‡§õ‡§≤‡•á ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡•Å‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®: {amount}",
                 overallGrossSummary: "‡§ï‡•Å‡§≤ ‡§∏‡§ï‡§≤ ‡§ï‡§Æ‡§æ‡§à: {amount}", initialCarriedOverBalanceSummary: "‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§‡•Ä ‡§≤‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ({month} ‡§∏‡•á): {amount}",
                 overallFinalBalanceDue: "‡§ï‡•Å‡§≤ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§¶‡•á‡§Ø: {amount}", noDataForOverallReport: "{user} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•Å‡§≤ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§",
                 includeBalanceOf: "‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§∞‡•á‡§Ç ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡§ø‡§∏‡§ï‡§æ:", otherUserPeriodEarnings: "‡§™‡•Ä‡§∞‡§ø‡§Ø‡§° ‡§ï‡§Æ‡§æ‡§à {otherUser} ‡§ï‡•á ‡§≤‡§ø‡§è: {amount}",
                 otherUserPeriodReceived: "‡§™‡•Ä‡§∞‡§ø‡§Ø‡§° ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ (‡§∞‡•ã‡§ú‡§æ‡§®‡§æ) {otherUser} ‡§ï‡•á ‡§≤‡§ø‡§è: {amount}", otherUserPeriodNet: "‡§™‡•Ä‡§∞‡§ø‡§Ø‡§° ‡§®‡•á‡§ü {otherUser} ‡§ï‡•á ‡§≤‡§ø‡§è ({earnings} - {received}): {amount}",
                 otherUserFinalBalance: "Final Balance Due for {otherUser}: {amount}", combinedFinalBalance: "Combined Final Balance Due ({currentUser} + {otherUser}'s Final Balance): {amount}",
                 footerIncludeOtherUserFinalBalance: "\n({otherUser} ‡§ï‡§æ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•à: {otherUserFinalBalance}) \n‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏: {combinedBalance}",
                 overtimeRateLabel: "‡§ì‡§µ‡§∞‡§ü‡§æ‡§á‡§Æ ‡§ò‡§Ç‡§ü‡•á ‡§™‡•ç‡§∞‡§§‡§ø ‡§π‡§æ‡§ú‡§º‡§ø‡§∞‡•Ä ‡§¶‡§∞:", otRatePlaceholder: "‡§ì‡§ü‡•Ä ‡§¶‡§∞", selectUserPlaceholder: "-- ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç --",
                 ratePlaceholderShort: "‡§¶‡§∞", otRatePlaceholderShort: "‡§ì‡§ü‡•Ä", balancePlaceholderShort: "‡§¨‡•à‡§≤‡•á‡§Ç‡§∏", selectUserPlaceholderShort: "-- ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç --",
                 editedDatePlaceholder: "DD-MM-YYYY", editedTimePlaceholder: "HH:MM",
                 notesModalTitle: "‡§®‡•ã‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç/‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç", saveNote: "‡§®‡•ã‡§ü ‡§∏‡§π‡•á‡§ú‡•á‡§Ç", totalLabel: "‡§ï‡•Å‡§≤",
                 alertPaymentDateRequired: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§",
                 carriedOverBalanceFromPrevMonth: "‡§≤‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (‡§™‡§ø‡§õ‡§≤‡•á ‡§Æ‡§π‡•Ä‡§®‡•á ‡§∏‡•á): {amount}",
                 carriedOverBalanceFromPrevPeriod: "‡§≤‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (1-15 ‡§Ö‡§µ‡§ß‡§ø ‡§∏‡•á): {amount}",


includeNotesOption: "‡§®‡•ã‡§ü‡•ç‡§∏ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§∞‡•á‡§Ç",
includeEditedOption: "‡§è‡§°‡§ø‡§ü‡§ø‡§Ç‡§ó ‡§∏‡§Æ‡§Ø ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§∞‡•á‡§Ç",
                 clearAllBalances: "‡§∏‡§≠‡•Ä ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç",
                 confirmClearBalances: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§∏‡§≠‡•Ä ‡§Ø‡•Ç‡§ú‡§º‡§∞‡•ç‡§∏ ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§™‡§ø‡§õ‡§≤‡•á ‡§Æ‡§π‡•Ä‡§®‡•ã‡§Ç ‡§ï‡•á '‡§≤‡§æ‡§è ‡§ó‡§è ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏' ‡§ï‡•ã 0 ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§¶‡•á‡§ó‡§æ‡•§ ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§",
                 alertBalancesCleared: "‡§∏‡§≠‡•Ä ‡§≤‡§æ‡§è ‡§ó‡§è ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç!"
            }
        };
        let currentLanguage = localStorage.getItem('appLanguage') || 'hi';
        let data = {};
        let currentUser = null;
        let calculationMode = 'fullMonth'; 
        let currentlyViewedPeriod = null; 

        let importDataBuffer = null;
        let showArchivedUsers = false;

        const RENDER_DELAY = 100;
        let renderTimeout = null;
        let saveStatusTimeout = null;
        let summaryUpdateTimeout = null;
        
        // --- NEW: Helper functions for accurate currency calculations ---
        const toCents = (amount) => Math.round(parseFloat(amount || 0) * 100);
        const fromCents = (amount) => (amount || 0) / 100;

        function translate(key, params = {}) {
            let text = translations[currentLanguage]?.[key] || translations['en']?.[key] || key;
             for (const param in params) {
                 text = text.replace(new RegExp(`{${param}}`, 'g'), params[param]);
             }
             return text;
        }

        function applyTranslationsToUI() {
             document.querySelectorAll('[data-translate-key]').forEach(element => {
                 element.textContent = translate(element.getAttribute('data-translate-key'));
             });
             document.querySelectorAll('[data-translate-key-placeholder]').forEach(element => {
                  element.placeholder = translate(element.getAttribute('data-translate-key-placeholder'));
             });
              document.querySelectorAll('[data-translate-key-title]').forEach(element => {
                  element.title = translate(element.getAttribute('data-translate-key-title'));
             });
             const hideUsersBtn = document.getElementById('hideUsersBtn');
             if (hideUsersBtn) {
                  hideUsersBtn.querySelector('span').textContent = translate('hideShowNames');
             }
              const langDisplay = document.getElementById('currentLangDisplay');
              if (langDisplay) langDisplay.textContent = currentLanguage.toUpperCase();

              const tableHead = document.querySelector('#tableContainer thead tr');
               if (tableHead) {
                    const headers = tableHead.querySelectorAll('th');
                    if(headers.length >= 8) {
                        headers[0].textContent = translate('dateHeaderTbl');
                        headers[1].textContent = translate('statusHeaderTbl');
                        headers[2].textContent = translate('otHeaderTbl');
                        headers[3].textContent = translate('rentHeaderTbl');
                        headers[4].textContent = translate('foodHeaderTbl');
                        headers[5].textContent = translate('receivedHeaderTbl');
                        headers[6].textContent = translate('notesHeaderTbl');
                        headers[7].textContent = translate('editedHeaderTbl');
                    }
               }
               updatePeriodDisplay();

                const archiveUserBtn = document.getElementById('archiveUserBtn');
                if (archiveUserBtn && currentUser && data[currentUser]) {
                    const isArchived = data[currentUser].isActive === false;
                    archiveUserBtn.textContent = translate(isArchived ? 'reactivateUser' : 'archiveUser');
                    archiveUserBtn.className = '';
                    archiveUserBtn.classList.add(isArchived ? 'reactivate-style' : 'archive-style');
                } else if (archiveUserBtn) {
                     archiveUserBtn.style.display = 'none';
                }

                const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
                if (toggleArchivedBtn) {
                    toggleArchivedBtn.textContent = showArchivedUsers ? translate('hideArchived') : translate('showArchived');
                }

                 const rateLabel = document.querySelector('label[for="userRate"]');
                 if (rateLabel) rateLabel.textContent = translate('rateLabel');
                 const overtimeRateLabel = document.querySelector('label[for="userOvertimeRate"]');
                 if(overtimeRateLabel) overtimeRateLabel.textContent = translate('overtimeRateLabel');
                 const manualBalanceLabel = document.querySelector('label[for="manualCarriedOverBalance"]');
                 if (manualBalanceLabel) manualBalanceLabel.textContent = translate('manualBalanceLabel');
                 const includeBalanceLabel = document.querySelector('label[for="otherUserForReport"]');
                 if(includeBalanceLabel) includeBalanceLabel.textContent = translate('includeBalanceOf');
                 const selectPlaceholderOption = document.querySelector('#otherUserForReport option[disabled][hidden]');
                 if(selectPlaceholderOption) selectPlaceholderOption.textContent = translate('selectUserPlaceholderShort');

                 const importPreviewTitle = document.querySelector('#importPreviewModal .modal-title');
                 if(importPreviewTitle) importPreviewTitle.textContent = translate('importPreviewTitle');

                 const notesModalTitleEl = document.querySelector('#notesModal .modal-title[data-translate-key="notesModalTitle"]');
                 if(notesModalTitleEl) {
                    const currentText = notesModalTitleEl.textContent;
                    if (!currentText.includes(" - ") || currentText.startsWith(translations[currentLanguage === 'en' ? 'hi' : 'en']['notesModalTitle'])) {
                         notesModalTitleEl.textContent = translate('notesModalTitle');
                    }
                 }

                document.querySelectorAll('.edited-date-input').forEach(el => el.placeholder = translate('editedDatePlaceholder'));
                document.querySelectorAll('.edited-time-input').forEach(el => el.placeholder = translate('editedTimePlaceholder'));
                const saveNoteModalBtn = document.getElementById('saveNoteModalBtn');
                if (saveNoteModalBtn) saveNoteModalBtn.textContent = translate('saveNote');
                const notesModalCancelBtn = document.querySelector('#notesModal .modal-footer button[onclick="closeNotesModal()"]');
                if (notesModalCancelBtn) notesModalCancelBtn.textContent = translate('cancel');
                const notesTextarea = document.getElementById('modalNoteTextarea');
                if (notesTextarea) notesTextarea.placeholder = translate('notesPlaceholder');

                const totalLabelCell = document.querySelector('#tableFooterRow td[data-translate-key="totalLabel"]');
                if(totalLabelCell) totalLabelCell.textContent = translate('totalLabel');
        }

        function toggleLanguage() {
            currentLanguage = (currentLanguage === 'en') ? 'hi' : 'en';
            localStorage.setItem('appLanguage', currentLanguage);
            document.documentElement.lang = currentLanguage;
            applyTranslationsToUI();
             scheduleFullRender();
        }
        function setDarkMode(isDark) {
            const htmlElement = document.documentElement;
             const toggleIcon = document.getElementById('darkModeToggleBtn')?.querySelector('i');
             if (isDark) {
                 htmlElement.classList.add('dark');
                 localStorage.setItem('darkMode', 'enabled');
                 if(toggleIcon) { toggleIcon.classList.remove('fa-moon'); toggleIcon.classList.add('fa-sun'); }
             } else {
                 htmlElement.classList.remove('dark');
                 localStorage.setItem('darkMode', 'disabled');
                 if(toggleIcon) { toggleIcon.classList.remove('fa-sun'); toggleIcon.classList.add('fa-moon'); }
             }
              scheduleFullRender();
        }
        function toggleDarkMode() { setDarkMode(!document.documentElement.classList.contains('dark')); }
        if (localStorage.getItem('darkMode') === 'enabled') setDarkMode(true); else setDarkMode(false);

        function checkReminders() {
            const reminderDiv = document.getElementById('reminderArea');
              if (!reminderDiv) return;
              if (!currentUser || (data[currentUser] && data[currentUser].isActive === false)) {
                  reminderDiv.style.display = 'none'; return;
              }
              if (!currentlyViewedPeriod) { reminderDiv.style.display = 'none'; return; }
              const monthKey = currentlyViewedPeriod.split('_')[0];
              const [year, monthNum] = monthKey.split('-').map(Number);
              const today = new Date();
              const currentSystemYear = today.getFullYear();
              const currentSystemMonth = today.getMonth() + 1;

              if (year === currentSystemYear && monthNum === currentSystemMonth) {
                  const endOfMonth = new Date(year, monthNum, 0).getDate();
                  const currentDayOfMonth = today.getDate();
                  if (endOfMonth - currentDayOfMonth <= 3 && endOfMonth - currentDayOfMonth >= 0) {
                       reminderDiv.textContent = translate('reminderFinalize');
                       reminderDiv.style.display = 'block';
                   } else {
                       reminderDiv.style.display = 'none';
                   }
              } else {
                  reminderDiv.style.display = 'none';
              }
        }

        function fullRender() {
             updateUserControls(); // FIXED: Ensure controls are always up-to-date

             const userControl = document.getElementById("userControl");
             const tableContainer = document.getElementById("tableContainer");
             const monthlySummarySection = document.getElementById("summarySection");
             const overallSummarySection = document.getElementById("overallSummarySection");
             const paymentsSection = document.getElementById('previousBalancePaymentsSection');
             const footerDiv = document.getElementById('reportFooter');
             const quickChange = document.getElementById('quickMonthChangeBtn');
             const userQuickControls = document.getElementById('userQuickControls');

             if (!currentUser || !currentlyViewedPeriod || !data[currentUser]) {
                 userControl.style.display = "none";
                 tableContainer.innerHTML = "";
                 monthlySummarySection.innerHTML = "";
                 monthlySummarySection.style.display = 'none';
                 overallSummarySection.innerHTML = "";
                 overallSummarySection.style.display = 'none';
                 paymentsSection.style.display = 'none';
                 if(footerDiv) footerDiv.textContent = '';
                 document.getElementById('currentMonthDisplay').textContent = '';
                 if(quickChange) quickChange.style.display = 'none';
                 if(userQuickControls) userQuickControls.style.display = 'none';
                 const dataManagementButtons = document.getElementById('dataManagementButtons');
                 const archiveBtn = document.getElementById('archiveUserBtn');
                 if ((dataManagementButtons.style.display === 'flex' || dataManagementButtons.style.display === 'block') && archiveBtn) {
                     archiveBtn.style.display = 'none';
                 }
                 checkReminders();
                 return;
             }
             userControl.style.display = "block";
             paymentsSection.style.display = 'block';
             if(quickChange) quickChange.style.display = 'inline-block';
             if(userQuickControls) userQuickControls.style.display = 'flex';
             monthlySummarySection.style.display = 'block';
             overallSummarySection.style.display = 'none';

             renderTable();
             showSummary();
             checkReminders();
             applyTranslationsToUI();
        }
        function scheduleFullRender(delay = RENDER_DELAY) { 
            if (renderTimeout) clearTimeout(renderTimeout); 
            renderTimeout = setTimeout(fullRender, delay); 
        }

        function scheduleSummaryUpdate(delay = 350) {
            if (summaryUpdateTimeout) {
                clearTimeout(summaryUpdateTimeout);
            }
            summaryUpdateTimeout = setTimeout(() => {
                if (!currentUser || !currentlyViewedPeriod) return;
                showSummary();
                const [monthKey, periodPart] = currentlyViewedPeriod.split('_');
                const [year, monthNum] = monthKey.split('-').map(Number);
                const daysInMonth = getDaysInMonth(year, monthNum - 1);
                
                let startDayIndex = 0;
                let endDayIndexExclusive = daysInMonth;

                if (calculationMode === 'halfMonth') {
                    if (periodPart === '1') {
                        endDayIndexExclusive = 15;
                    } else {
                        startDayIndex = 15;
                    }
                }
                
                updateTableFooter(monthKey, startDayIndex, endDayIndexExclusive);
            }, delay);
        }












        function showSaveStatus(message, statusType = 'success', duration = 3000) {
            const indicator = document.getElementById('saveStatusIndicator');
            if (!indicator) return;

            if (saveStatusTimeout) {
                clearTimeout(saveStatusTimeout);
            }

            indicator.textContent = message;
            indicator.className = statusType; // 'saving', 'success', or 'error'
            indicator.style.display = 'block';
            indicator.style.opacity = '1';

            if (duration > 0) {
                saveStatusTimeout = setTimeout(() => {
                    indicator.style.opacity = '0';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 500); // Wait for fade out transition
                }, duration);
            }
        }

        // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ saveData ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§á‡§∏‡•á ‡§°‡§æ‡§≤‡•á‡§Ç
function saveData() {
    if (!masterAdminId) return;
    db.collection("attendance").doc(masterAdminId).set({
        attendanceData: data,
        lastUpdated: new Date().toISOString()
    });
}



        
        function toggleCalculationMode() {
            calculationMode = (calculationMode === 'fullMonth') ? 'halfMonth' : 'fullMonth';
            localStorage.setItem('calculationMode', calculationMode);
            setModeIcon();
            
            if (currentlyViewedPeriod) {
                const monthKey = currentlyViewedPeriod.split('_')[0];
                if (calculationMode === 'fullMonth') {
                    currentlyViewedPeriod = monthKey;
                } else {
                    const today = new Date();
                    const currentDay = today.getDate();
                    if (monthKey === `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, "0")}`) {
                        currentlyViewedPeriod = `${monthKey}_${currentDay <= 15 ? '1' : '2'}`;
                    } else {
                        currentlyViewedPeriod = `${monthKey}_1`;
                    }
                }
            }
            scheduleFullRender();
        }

        function setModeIcon() {
            const modeIcon = document.getElementById('modeIcon');
            const modeToggleBtn = document.getElementById('modeToggleBtn');
            if (modeIcon && modeToggleBtn) {
                if (calculationMode === 'halfMonth') {
                    modeIcon.textContent = 'üåì';
                    modeToggleBtn.title = translate('halfMonthMode');
                } else {
                    modeIcon.textContent = 'üìÖ';
                    modeToggleBtn.title = translate('fullMonthMode');
                }
            }
        }

        function addUser() {
    const nameInput = document.getElementById("newUserName");
    const name = nameInput.value.trim();
    
    // 1. ‡§Ö‡§ó‡§∞ ‡§®‡§æ‡§Æ ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§§‡•ã ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§¶‡•á‡§Ç
    if (!name) { 
        alert(translate('alertEnterName')); 
        return; 
    }

    // 2. ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§®‡§æ‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à (Case-insensitive check)
    const existingUserName = Object.keys(data).find(key => key.toLowerCase() === name.toLowerCase());

    if (existingUserName) {
        const existingUser = data[existingUserName];
        // ‡§Ö‡§ó‡§∞ ‡§®‡§æ‡§Æ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® ‡§°‡§ø‡§≤‡•Ä‡§ü (Archive) ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•Å‡§Ü ‡§π‡•à
        if (existingUser.isActive === false) {
            if (confirm(translate('confirmReactivateUser', { name: existingUserName }))) {
                existingUser.isActive = true; 
                saveData(); // ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§™‡§∞ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                alert(translate('alertUserReactivated', { name: existingUserName }));
                nameInput.value = ""; 
                renderUserTabs(); 
                selectUser(existingUserName); 
                return;
            } else { 
                nameInput.value = ""; 
                return; 
            }
        } else {
            // ‡§Ö‡§ó‡§∞ ‡§®‡§æ‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§π‡•à
            alert(translate('alertUserExists', { name: existingUserName }).split('?')[0]);
            nameInput.value = ""; 
            return;
        }
    }

    // 3. ‡§®‡§æ‡§Æ ‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç (‡§ú‡•à‡§∏‡•á: mohan das -> Mohan Das)
    const formattedName = name.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

    // 4. ‡§®‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç (‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§™‡§ï‡§æ ‡§Æ‡§æ‡§Ç‡§ó‡§æ ‡§π‡•Å‡§Ü ‡§ï‡•ã‡§° ‡§π‡•à)
    // ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§≤‡•â‡§ó‡§ø‡§® ‡§π‡•à
    if (loggedInUser) {
        data[formattedName] = { 
            rate: 0, 
            overtimeRate: 8, 
            months: {}, 
            isActive: true,
            invitedBy: loggedInUser.uid,               // ‡§†‡•á‡§ï‡•á‡§¶‡§æ‡§∞/‡§è‡§°‡§Æ‡§ø‡§® ‡§ï‡•Ä ID
            ownerName: loggedInUser.email.split('@')[0] // ‡§†‡•á‡§ï‡•á‡§¶‡§æ‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§à‡§Æ‡•á‡§≤ ‡§∏‡•á)
        };

        // 5. ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§°‡•á‡§ü‡§æ ‡§∏‡§ø‡§Ç‡§ï ‡§ï‡§∞‡•á‡§Ç
        saveData(); 

        // 6. ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§Ç ‡§î‡§∞ UI ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        alert(translate('alertUserAdded', {name: formattedName}));
        nameInput.value = ""; 
        renderUserTabs(); 
        selectUser(formattedName);
    } else {
        alert("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§ú‡•ã‡•ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•â‡§ó‡§ø‡§® ‡§π‡•ã‡§®‡§æ ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡•§");
    }
}




        function toggleArchiveCurrentUser() {
            if (!currentUser || !data[currentUser]) { return; }
            const user = data[currentUser]; const isArchived = user.isActive === false;
            const confirmAction = isArchived
                ? confirm(translate('confirmReactivateUser', { name: currentUser }))
                : confirm(translate('confirmArchiveUser', { name: currentUser }));

            if (confirmAction) {
                user.isActive = !isArchived; saveData();
                alert(translate(isArchived ? 'alertUserReactivated' : 'alertUserArchived', { name: currentUser }));
                if (!user.isActive && !showArchivedUsers) {
                    currentUser = null; currentlyViewedPeriod = null; localStorage.removeItem('lastSelectedUser');
                    scheduleFullRender(); renderUserTabs();
                } else {
                    renderUserTabs();
                    selectUser(currentUser);
                }
            }
        }
        function toggleArchivedUsers() {
             showArchivedUsers = !showArchivedUsers; renderUserTabs();
             if (currentUser && data[currentUser]?.isActive === false && !showArchivedUsers) {
                 currentUser = null; currentlyViewedPeriod = null; localStorage.removeItem('lastSelectedUser'); scheduleFullRender();
             } else if (!currentUser && showArchivedUsers) {
                  const lastUser = localStorage.getItem('lastSelectedUser');
                 if(lastUser && data[lastUser] && data[lastUser].isActive === false) { selectUser(lastUser); }
             }
             applyTranslationsToUI();
        }

        function populateOtherUserDropdown() {
            const selectElement = document.getElementById('otherUserForReport');
            if (!selectElement) { return; }
            const currentSelectedOtherUser = selectElement.value;
            selectElement.querySelectorAll('option:not([disabled][hidden])').forEach(option => option.remove());
            const activeUserNames = Object.keys(data)
                .filter(name => data[name] && data[name].isActive !== false)
                .sort((a, b) => a.localeCompare(b));
            activeUserNames.forEach(name => {
                if (name !== currentUser) {
                    const option = document.createElement('option'); option.value = name; option.textContent = name;
                    selectElement.appendChild(option);
                }
            });
             if (currentSelectedOtherUser && currentSelectedOtherUser !== currentUser && activeUserNames.includes(currentSelectedOtherUser)) {
                 selectElement.value = currentSelectedOtherUser;
             } else {
                 selectElement.value = "";
             }
        }

        

function renderUserTabs() {
    // 1. ‡§∏‡§¨‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§°‡•á‡§ü‡§æ ‡§∏‡•á ‡§∏‡§æ‡§∞‡•á ‡§®‡§æ‡§Æ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§ï‡•ç‡§∞‡§Æ (A-Z) ‡§Æ‡•á‡§Ç ‡§≤‡§ó‡§æ‡§è‡§Ç
    let sortedUserNames = Object.keys(data).sort((a, b) => a.localeCompare(b));

    // 2. ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§∞‡•ã‡§≤ ‡§ï‡•á ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§∏‡•á ‡§®‡§æ‡§Æ‡•ã‡§Ç ‡§ï‡•ã ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç (Permissions Logic)
    if (loggedInUser) {
        if (loggedInUser.role === 'user') {
            // ‡§µ‡§∞‡•ç‡§ï‡§∞ (User) ‡§ï‡•ã ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§â‡§∏‡§ï‡§æ ‡§Ö‡§™‡§®‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§µ‡§æ‡§≤‡§æ ‡§®‡§æ‡§Æ ‡§π‡•Ä ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ
            sortedUserNames = sortedUserNames.filter(name => name === loggedInUser.email);
            
            // ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ: ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§®‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§∏‡§ø‡§≤‡•á‡§ï‡•ç‡§ü ‡§π‡•à, ‡§§‡•ã ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§∏‡§ø‡§≤‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ú‡§æ‡§è
            if (sortedUserNames.length > 0 && !currentUser) {
                selectUser(sortedUserNames[0]);
            }
        } 
        else if (loggedInUser.role === 'super') {
            // ‡§∏‡•Å‡§™‡§∞ ‡§Ø‡•Ç‡§ú‡§∞ (‡§†‡•á‡§ï‡•á‡§¶‡§æ‡§∞) ‡§ï‡•ã ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§µ‡§π‡•Ä ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§¶‡§ø‡§ñ‡•á‡§Ç‡§ó‡•á ‡§ú‡§ø‡§®‡•ç‡§π‡•á‡§Ç ‡§â‡§∏‡§®‡•á ‡§ñ‡•Å‡§¶ ‡§ú‡•ã‡•ú‡§æ (invitedBy) ‡§π‡•à
            sortedUserNames = sortedUserNames.filter(name => data[name].invitedBy === loggedInUser.uid);
        }
        // ‡§è‡§°‡§Æ‡§ø‡§® (Admin) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§®‡§π‡•Ä‡§Ç, ‡§â‡§∏‡•á ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ
    }

    // --- ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§Ü‡§™‡§ï‡§æ ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® ‡§î‡§∞ ‡§¨‡§ü‡§® ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à ---
    const tabContainer = document.getElementById("userTabs");
    const hideUsersBtn = document.getElementById("hideUsersBtn");
    const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
    tabContainer.innerHTML = '';

    // ‡§Ö‡§ó‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§§‡•ã ‡§ü‡•à‡§¨ ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§õ‡§ø‡§™‡§æ ‡§¶‡•á‡§Ç
    if (sortedUserNames.length === 0) {
        tabContainer.style.display = 'none';
        if(toggleArchivedBtn) toggleArchivedBtn.style.display = 'none';
        if(hideUsersBtn) hideUsersBtn.style.display = 'none';
        populateOtherUserDropdown(); 
        document.getElementById('includeBalanceContainer').style.display = 'none';
        return;
    } else {
        if (tabContainer.style.display === 'none' || tabContainer.style.display === "") tabContainer.style.display = 'flex';
        if(hideUsersBtn) hideUsersBtn.style.display = 'inline-block';
        
        // ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§ø‡§è ‡§π‡•Å‡§è ‡§®‡§æ‡§Æ‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§Ü‡§∞‡•ç‡§ï‡§æ‡§á‡§µ (‡§õ‡§ø‡§™‡§æ ‡§π‡•Å‡§Ü) ‡§Ø‡•Ç‡§ú‡§∞ ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç
        const hasArchived = sortedUserNames.some(name => data[name].isActive === false);
        if(toggleArchivedBtn) toggleArchivedBtn.style.display = hasArchived || showArchivedUsers ? 'inline-block' : 'none';
        
        if (currentUser) document.getElementById('includeBalanceContainer').style.display = 'flex'; 
        else document.getElementById('includeBalanceContainer').style.display = 'none';
    }

    // 3. ‡§¨‡§ü‡§® ‡§¨‡§®‡§æ‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
    sortedUserNames.forEach(name => {
        const user = data[name];
        if (user && (user.isActive !== false || showArchivedUsers)) {
            const btn = document.createElement("button");
            
            // ‡§è‡§°‡§Æ‡§ø‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡§æ‡§∏ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä: ‡§®‡§æ‡§Æ ‡§ï‡•á ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ ‡§ï‡§ø ‡§â‡§∏‡•á ‡§ï‡§ø‡§∏ ‡§†‡•á‡§ï‡•á‡§¶‡§æ‡§∞ ‡§®‡•á ‡§ú‡•ã‡•ú‡§æ ‡§π‡•à
            if (loggedInUser.role === 'admin' && user.ownerName) {
                btn.innerHTML = `${name}<br><small style="font-weight:normal; font-size:9px; opacity:0.7;">(‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ: ${user.ownerName})</small>`;
            } else {
                btn.textContent = name;
            }

            btn.onclick = () => selectUser(name); 
            btn.classList.add('user-tab-button');
            
            // ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§Ü‡§∞‡•ç‡§ï‡§æ‡§á‡§µ ‡§Ø‡§æ ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ)
            if (user.isActive === false) btn.classList.add('archived');
            if (name === currentUser) btn.classList.add('active-user-tab');
            
            tabContainer.appendChild(btn);
        }
    });

    applyTranslationsToUI(); 
    populateOtherUserDropdown();
}






        function toggleUsers() {
            const tabContainer = document.getElementById("userTabs");
             if (Object.keys(data).length === 0) { tabContainer.style.display = 'none'; return; }
             tabContainer.style.display = (tabContainer.style.display === "none" || tabContainer.style.display === "") ? "flex" : "none";
        }
        
        // --- NEW/REFACTORED: Central function to update user control inputs ---
        function updateUserControls() {
            if (!currentUser || !data[currentUser]) return;

            const rate = Number(data[currentUser]?.rate) || 0;
            document.getElementById("userRate").value = rate === 0 ? '' : rate;

            const overtimeRate = Number(data[currentUser]?.overtimeRate) || 8;
            document.getElementById("userOvertimeRate").value = overtimeRate === 8 ? '' : overtimeRate;

            if (currentlyViewedPeriod) {
                const monthKey = currentlyViewedPeriod.split('_')[0];
                const monthDataForInput = data[currentUser]?.months?.[monthKey];
                if (monthDataForInput) {
                    const carriedOver = monthDataForInput.carriedOverBalance || 0;
                    document.getElementById("manualCarriedOverBalance").value = Number(carriedOver) === 0 ? '' : Number(carriedOver);
                } else {
                    document.getElementById("manualCarriedOverBalance").value = '';
                }
            } else {
                 document.getElementById("manualCarriedOverBalance").value = '';
            }
        }

        function selectUser(name) {
             if (!data[name]) {
                 currentUser = null; currentlyViewedPeriod = null; localStorage.removeItem('lastSelectedUser');
                 scheduleFullRender(); renderUserTabs(); populateOtherUserDropdown(); return;
             }
             currentUser = name; localStorage.setItem('lastSelectedUser', name);
             document.getElementById("selectedUserName").textContent = name;
             
             let periodToView = currentlyViewedPeriod;
             if (!periodToView) {
                 periodToView = getCurrentPeriod();
             }
             currentlyViewedPeriod = periodToView;
             
             const currentMonthKey = currentlyViewedPeriod.split('_')[0];
             if (!data[name].months) data[name].months = {};
             if (!data[name].months[currentMonthKey]) {
                 data[name].months[currentMonthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
             }
             
             updateUserControls(); // Use the new central function

             renderUserTabs();
             populateOtherUserDropdown();
             scheduleFullRender();
        }

        document.getElementById("userRate").addEventListener("input", (event) => {
            if (currentUser && data[currentUser]) {
                 const rateVal = parseFloat(event.target.value);
                 data[currentUser].rate = !isNaN(rateVal) && rateVal >= 0 ? rateVal : 0;
                 saveData();
                 scheduleSummaryUpdate();
             }
        });
         document.getElementById("userRate").addEventListener("change", (event) => {
            if(currentUser && data[currentUser]){
                event.target.value = data[currentUser].rate === 0 ? '' : data[currentUser].rate;
            }
         });

        document.getElementById("userOvertimeRate").addEventListener("input", (event) => {
            if (currentUser && data[currentUser]) {
                const otRateVal = parseFloat(event.target.value);
                data[currentUser].overtimeRate = (!isNaN(otRateVal) && otRateVal > 0) ? otRateVal : 8;
                saveData();
                scheduleSummaryUpdate();
            }
        });
        document.getElementById("userOvertimeRate").addEventListener("change", (event) => {
             if(currentUser && data[currentUser]){
                event.target.value = data[currentUser].overtimeRate === 8 ? '' : data[currentUser].overtimeRate;
            }
        });

        document.getElementById("manualCarriedOverBalance").addEventListener("input", (event) => {
            if (!currentUser || !currentlyViewedPeriod) return;
            const monthKey = currentlyViewedPeriod.split('_')[0];
            if(!data[currentUser]?.months?.[monthKey]) return;
            const balanceVal = parseFloat(event.target.value) || 0;
            data[currentUser].months[monthKey].carriedOverBalance = balanceVal;
            saveData();
            scheduleSummaryUpdate();
        });
        document.getElementById("manualCarriedOverBalance").addEventListener("change", (event) => {
             if (!currentUser || !currentlyViewedPeriod) return;
             const monthKey = currentlyViewedPeriod.split('_')[0];
             if(!data[currentUser]?.months?.[monthKey]) return;
             event.target.value = data[currentUser].months[monthKey].carriedOverBalance === 0 ? '' : data[currentUser].months[monthKey].carriedOverBalance;
        });

        function renderPreviousBalancePayments() {
            const paymentListDiv = document.getElementById('paymentList'); paymentListDiv.innerHTML = '';
            if (!currentUser || !currentlyViewedPeriod) {
                 paymentListDiv.innerHTML = `<p>${translate('noPaymentsRecorded')}</p>`; return;
            }
            
            const [monthKey, periodPart] = currentlyViewedPeriod.split('_');
            const payments = data[currentUser]?.months?.[monthKey]?.previousBalancePayments;

            if (!Array.isArray(payments) || payments.length === 0) {
                paymentListDiv.innerHTML = `<p>${translate('noPaymentsRecorded')}</p>`; return;
            }

            let periodPayments = payments;
            if (calculationMode === 'halfMonth') {
                periodPayments = payments.filter(p => {
                    const paymentDay = new Date(p.date).getDate();
                    return periodPart === '1' ? paymentDay <= 15 : paymentDay > 15;
                });
            }

            if (periodPayments.length === 0) {
                 paymentListDiv.innerHTML = `<p>${translate('noPaymentsRecorded')}</p>`; return;
            }

            const sortedPayments = [...periodPayments].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedPayments.forEach((p) => {
                const actualIndex = payments.findIndex(origP => origP.date === p.date && origP.amount === p.amount && origP.notes === p.notes);
                 if (!p || typeof p !== 'object' || p.amount === undefined || actualIndex === -1) { return; }
                const entry = document.createElement('div'); entry.className = 'payment-entry';
                const details = document.createElement('span'); details.className = 'payment-details';
                let paymentDateStr = translate('noDate');
                if (p.date) {
                    try {
                        const dateObj = new Date(p.date);
                        if (!isNaN(dateObj.getTime())) {
                             paymentDateStr = dateObj.toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN' : 'en-GB', {year:'numeric',month:'numeric',day:'numeric'});
                        }
                    } catch (e) { console.warn("Invalid payment date stored:", p.date); }
                }
                details.textContent = `${translate('amountLabel')} ${(Number(p.amount)||0).toFixed(2)}, ${translate('dateLabel')} ${paymentDateStr}${p.notes ? ` (${p.notes})` : ''}`;
                const btn = document.createElement('button'); btn.className = 'delete-payment-btn'; btn.textContent = '‚úï';
                btn.onclick = () => deletePreviousBalancePayment(monthKey, actualIndex);
                entry.append(details, btn); paymentListDiv.appendChild(entry);
            });
        }
        function addPreviousBalancePayment() {
            if (!currentUser || !currentlyViewedPeriod || !data[currentUser]?.months?.[currentlyViewedPeriod.split('_')[0]]) {
                 alert(translate('alertSelectUserMonth')); return;
            }
            const amountInput = document.getElementById('paymentAmount');
            const dateInput = document.getElementById('paymentDate');
            const notesInput = document.getElementById('paymentNotes');
            const amount = parseFloat(amountInput.value);
            const paymentDateValue = dateInput.value;
            if (isNaN(amount) || amount <= 0) { alert(translate('alertEnterValidAmount')); return; }
            if (!paymentDateValue) { alert(translate('alertPaymentDateRequired')); return; }
            
            const [year, month, day] = paymentDateValue.split('-').map(Number);
            const monthKeyForPayment = `${year}-${String(month).padStart(2,'0')}`;
            const monthKeyFromPeriod = currentlyViewedPeriod.split('_')[0];
            
            if (monthKeyForPayment !== monthKeyFromPeriod) {
                alert("Payment date must be in the currently viewed month.");
                return;
            }

            const notes = notesInput.value.trim();
            const monthData = data[currentUser].months[monthKeyForPayment];
            if(!Array.isArray(monthData.previousBalancePayments)) monthData.previousBalancePayments = [];
            
            const paymentDateObj = new Date(year, month - 1, day);
            monthData.previousBalancePayments.push({ amount, date: paymentDateObj.toISOString(), notes });
            saveData(); 
            renderPreviousBalancePayments();
            amountInput.value = ''; dateInput.value = ''; notesInput.value = '';
            alert(translate('alertPaymentAdded'));
            scheduleSummaryUpdate();
        }
        function deletePreviousBalancePayment(monthKey, index) {
            const payments = data[currentUser]?.months?.[monthKey]?.previousBalancePayments;
            if (!payments || index < 0 || index >= payments.length || !payments[index]) { return; }
            const payment = payments[index];
            if (confirm(translate('confirmDeletePayment', {amount: (Number(payment.amount)||0).toFixed(2)}))) {
                payments.splice(index, 1); saveData(); 
                renderPreviousBalancePayments();
                alert(translate('alertPaymentDeleted'));
                scheduleSummaryUpdate();
            }
        }

        function updatePeriodDisplay() {
            const monthDisplay = document.getElementById('currentMonthDisplay');
            const prevBtn = document.querySelector('#monthNav button:first-child');
            const nextBtn = document.querySelector('#monthNav button:last-child');
            const quickChangeBtn = document.getElementById('quickMonthChangeBtn');
            const manualBalanceInput = document.getElementById("manualCarriedOverBalance");

            if (monthDisplay && currentlyViewedPeriod) {
                const [monthKey, periodPart] = currentlyViewedPeriod.split('_');
                const [year, monthNum] = monthKey.split('-').map(Number);
                const monthName = new Intl.DateTimeFormat(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { month: 'long' }).format(new Date(year, monthNum - 1, 1));
                
                let displayText = `${monthName} ${year}`;
                if (calculationMode === 'halfMonth') {
                    displayText += ` (${periodPart === '1' ? '1-15' : '16-End'})`;
                }
                monthDisplay.textContent = displayText;

                if (currentUser && data[currentUser]?.months) {
                    prevBtn.disabled = false;
                    nextBtn.disabled = currentlyViewedPeriod >= getCurrentPeriod();
                    if(quickChangeBtn) quickChangeBtn.style.display = 'inline-block';
                    
                    if (manualBalanceInput) {
                         manualBalanceInput.disabled = (calculationMode === 'halfMonth' && periodPart === '2');
                     }
                } else {
                    [prevBtn, nextBtn].forEach(b=>b.disabled=true);
                    if(quickChangeBtn) quickChangeBtn.style.display='none';
                    if(manualBalanceInput) manualBalanceInput.disabled = true;
                }
            } else if (monthDisplay) {
                monthDisplay.textContent = ''; [prevBtn, nextBtn].forEach(b=>b.disabled=true);
                if(quickChangeBtn) quickChangeBtn.style.display='none';
                if(manualBalanceInput) manualBalanceInput.disabled = true;
            }
             checkReminders();
        }

        function goToPreviousPeriod() {
            if(!currentUser || !currentlyViewedPeriod) return;
            
            const prevPeriod = getRelativePeriod(currentlyViewedPeriod, -1);
            currentlyViewedPeriod = prevPeriod;

            const newMonthKey = currentlyViewedPeriod.split('_')[0];
            if (!data[currentUser].months[newMonthKey]) {
                data[currentUser].months[newMonthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
            }
            scheduleFullRender();
        }

        function goToNextPeriod() {
            if (!currentUser || !currentlyViewedPeriod) return;

            // --- NEW: Automatic Carry-Over Logic ---
            const currentPeriodSummary = calculateSummary(currentUser, currentlyViewedPeriod);
            if (currentPeriodSummary) {
                const finalBalance = currentPeriodSummary.finalBalanceForPeriod;
                const nextPeriod = getRelativePeriod(currentlyViewedPeriod, 1);
                
                const [nextMonthKey] = nextPeriod.split('_');
                const [year, monthNum] = nextMonthKey.split('-').map(Number);
                const monthName = new Intl.DateTimeFormat(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { month: 'long' }).format(new Date(year, monthNum - 1, 1));
                let periodTitle = `${monthName} ${year}`;
                 if (calculationMode === 'halfMonth') {
                    const periodPart = nextPeriod.split('_')[1];
                    periodTitle += ` (${periodPart === '1' ? '1-15' : '16-End'})`;
                }

                if (confirm(translate('confirmCarryOverBalance', { amount: finalBalance.toFixed(2), period: periodTitle }))) {
                    if (!data[currentUser].months[nextMonthKey]) {
                        data[currentUser].months[nextMonthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
                    }
                    data[currentUser].months[nextMonthKey].carriedOverBalance = finalBalance;
                    saveData();
                }
            }
            // --- End of New Logic ---

            const nextPeriod = getRelativePeriod(currentlyViewedPeriod, 1);
            if (nextPeriod > getCurrentPeriod()) {
                alert(translate('cannotGoToFutureMonth'));
                return;
            }
            
            currentlyViewedPeriod = nextPeriod;
            const newMonthKey = currentlyViewedPeriod.split('_')[0];
            if (!data[currentUser].months[newMonthKey]) {
                data[currentUser].months[newMonthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
            }

            scheduleFullRender();
        }
        
        function getRelativePeriod(period, offset) {
            const [monthKey, periodPart] = period.split('_');
            const [year, month] = monthKey.split('-').map(Number);
            
            if (calculationMode === 'fullMonth') {
                const date = new Date(year, month - 1, 1);
                date.setMonth(date.getMonth() + offset);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            } else {
                let currentAbsPeriod = (year * 24) + ((month - 1) * 2) + (periodPart === '1' ? 0 : 1);
                currentAbsPeriod += offset;
                const newYear = Math.floor(currentAbsPeriod / 24);
                const newMonth = Math.floor((currentAbsPeriod % 24) / 2) + 1;
                const newPeriodPart = (currentAbsPeriod % 2 === 0) ? '1' : '2';
                return `${newYear}-${String(newMonth).padStart(2, '0')}_${newPeriodPart}`;
            }
        }

        function promptQuickPeriodChange() {
             if(!currentUser){alert(translate('pleaseSelectUser')); return;}
             const promptText = translate('promptMonthInput');
             const defaultVal = currentlyViewedPeriod || getCurrentPeriod();
             const periodInput = prompt(promptText, defaultVal);
             
             if(!periodInput) return;
             const trimmedInput = periodInput.trim();
             const pattern = /^\d{4}-\d{2}(_([12]))?$/;
             if (!pattern.test(trimmedInput)) {
                 alert(translate('alertInvalidPeriodFormat'));
                 return;
             }
             
             const [monthKey, periodPart] = trimmedInput.split('_');
             const [year, monthNum] = monthKey.split('-').map(Number);
             if(year < 1900 || year > 2100 || monthNum < 1 || monthNum > 12){ 
                 alert(translate('alertInvalidPeriodFormat')); 
                 return; 
             }
             
             let newPeriod = monthKey;
             if (calculationMode === 'halfMonth') {
                 newPeriod = `${monthKey}_${periodPart || '1'}`;
             }
             
             if(newPeriod > getCurrentPeriod()){
                 alert(translate('cannotGoToFutureMonth'));
                 return;
             }
             
             if (!data[currentUser].months[monthKey]) {
                data[currentUser].months[monthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
             }
             currentlyViewedPeriod = newPeriod;
             scheduleFullRender();
        }

        function calculatePeriodTotals(userName, monthKey, startDayIndex, endDayIndexExclusive) { 
            const userData = data[userName];
             if (!userData?.months?.[monthKey] || !Array.isArray(userData.months[monthKey].days)) {
                 return { totalPresent:0, totalOvertimeHours:0, totalRent:0, totalFood:0, totalDailyReceived:0, periodGross:0 };
            }
             const actualDaysInMonthArray = userData.months[monthKey].days;
             const safeStart = Math.max(0, startDayIndex);
             const safeEndExclusive = Math.min(actualDaysInMonthArray.length, endDayIndexExclusive);

            const daysDataForPeriod = actualDaysInMonthArray.slice(safeStart, safeEndExclusive);
            let p=0, ot=0;
            let rInCents = 0, fInCents = 0, recInCents = 0;

            daysDataForPeriod.forEach(d => {
                 if(d && typeof d === 'object'){
                    const statusText = (d.status||'').toUpperCase(); let dayAttendanceValue = 0;
                    const multiplierMatch = statusText.match(/^(\d+)P$/);
                    if (multiplierMatch) {
                         const multiplier = parseInt(multiplierMatch[1]);
                         if (!isNaN(multiplier) && multiplier > 0) dayAttendanceValue = multiplier;
                    } else if (statusText === 'P') dayAttendanceValue = 1;
                    else if (statusText === 'H') dayAttendanceValue = 0.5;
                    p += dayAttendanceValue; 
                    ot+=Number(d.overtime)||0; 
                    rInCents += toCents(d.rent);
                    fInCents += toCents(d.food);
                    recInCents += toCents(d.received);
                }
            });

            const rateInCents = toCents(userData.rate); 
            const otRate = Number(userData.overtimeRate) || 8;
            const hazriInCents = Math.round(p * rateInCents); // p can be 0.5
            const otAmountInCents = (rateInCents > 0 && otRate > 0) ? Math.round((ot * rateInCents) / otRate) : 0;
            const periodGrossInCents = hazriInCents + otAmountInCents + rInCents + fInCents;

            return {
                totalPresent: parseFloat(p.toFixed(2)), 
                totalOvertimeHours: parseFloat(ot.toFixed(2)),
                totalRent: fromCents(rInCents), 
                totalFood: fromCents(fInCents),
                totalDailyReceived: fromCents(recInCents),
                periodGross: fromCents(periodGrossInCents)
            };
        }

        function getCurrentDateString() {
            const n = new Date(); return `${n.getDate()}/${n.getMonth() + 1}/${n.getFullYear()}`;
        }

        function getDaysInMonth(year, monthIndex) {
            return new Date(year, monthIndex + 1, 0).getDate();
        }

        function calculateOverallReport(userName) {
             const userData = data[userName]; if (!userData?.months || Object.keys(userData.months).length === 0) { return null; }
            const sortedMonthKeys = Object.keys(userData.months).sort();
            let totP=0, totOT=0;
            let totR_Cents=0, totF_Cents=0, totDR_Cents=0, totG_Cents=0, totPBP_Cents=0;

            const initBal_Cents = toCents(userData.months[sortedMonthKeys[0]]?.carriedOverBalance);
            const initBalMKey = sortedMonthKeys[0];

            sortedMonthKeys.forEach(mKey => {
                 const mData = userData.months[mKey];
                 if (mData && typeof mData === 'object') {
                      const mTots = calculatePeriodTotals(userName, mKey, 0, 31);
                      totP+=mTots.totalPresent; totOT+=mTots.totalOvertimeHours; 
                      totR_Cents += toCents(mTots.totalRent);
                      totF_Cents += toCents(mTots.totalFood);
                      totDR_Cents += toCents(mTots.totalDailyReceived);
                      totG_Cents += toCents(mTots.periodGross);
                      if (Array.isArray(mData.previousBalancePayments)) {
                           mData.previousBalancePayments.forEach(p => { 
                               if (p&&typeof p==='object'&&p.amount!==undefined) totPBP_Cents += toCents(p.amount); 
                            });
                      }
                 }
            });
            const overallFinBal_Cents = totG_Cents + initBal_Cents - totDR_Cents - totPBP_Cents;
            return {
                 totalOverallPresent:parseFloat(totP.toFixed(2)), totalOverallOvertimeHours:parseFloat(totOT.toFixed(2)),
                 totalOverallRent: fromCents(totR_Cents), totalOverallFood: fromCents(totF_Cents),
                 totalOverallDailyReceived: fromCents(totDR_Cents), totalOverallPrevBalPayments: fromCents(totPBP_Cents),
                 totalOverallGross: fromCents(totG_Cents), initialCarriedOverBalance: fromCents(initBal_Cents),
                 initialCarriedOverMonthKey:initBalMKey, overallFinalBalance: fromCents(overallFinBal_Cents)
            };
        }

        function displayOverallReport() {
            const monthlySummarySection = document.getElementById('summarySection');
            const overallSummarySection = document.getElementById('overallSummarySection');
            const tableContainer = document.getElementById('tableContainer');
            const paymentsSection = document.getElementById('previousBalancePaymentsSection');
            if (!currentUser) {
                monthlySummarySection.style.display = 'none';
                overallSummarySection.innerHTML = `<p>${translate('pleaseSelectUser')}</p>`;
                overallSummarySection.style.display = 'block';
                if(tableContainer) tableContainer.style.display = 'none';
                if(paymentsSection) paymentsSection.style.display = 'none';
                return;
            }
            const overallTotals = calculateOverallReport(currentUser);
            monthlySummarySection.style.display = 'none';
            if(tableContainer) tableContainer.style.display = 'none';
            if(paymentsSection) paymentsSection.style.display = 'none';
            overallSummarySection.innerHTML = '';
            if (!overallTotals) {
                 overallSummarySection.innerHTML = `<p>${translate('noDataForOverallReport', { user: currentUser })}</p>`;
                 overallSummarySection.style.display = 'block'; return;
            }
            let html = `<h3>${translate('overallReportTitle', { user: currentUser })}</h3>
                <p>${translate('overallAttendanceSummary', { days: overallTotals.totalOverallPresent.toFixed(2) })}</p>
                <p>${translate('overallOvertimeSummary', { hours: overallTotals.totalOverallOvertimeHours.toFixed(2) })}</p>
                <p>${translate('overallRentSummary', { amount: overallTotals.totalOverallRent.toFixed(2) })}</p>
                <p>${translate('overallFoodSummary', { amount: overallTotals.totalOverallFood.toFixed(2) })}</p>
                <hr><p><strong>${translate('overallGrossSummary', { amount: overallTotals.totalOverallGross.toFixed(2) })}</strong></p>
                 <p><strong>${translate('initialCarriedOverBalanceSummary', { amount: overallTotals.initialCarriedOverBalance.toFixed(2), month: overallTotals.initialCarriedOverMonthKey })}</strong></p>
                 <hr><p>${translate('overallDailyReceivedSummary', { amount: overallTotals.totalOverallDailyReceived.toFixed(2) })}</p>
                 <p>${translate('overallPrevBalPaymentsSummary', { amount: overallTotals.totalOverallPrevBalPayments.toFixed(2) })}</p>
                 <hr><p><strong>${translate('overallFinalBalanceDue', { amount: overallTotals.overallFinalBalance.toFixed(2) })}</strong></p>`;
            overallSummarySection.innerHTML = html;
            overallSummarySection.style.display = 'block';
            applyTranslationsToUI();
            const shareButtonWrapper = document.getElementById('shareReportButtonWrapper');
             if(shareButtonWrapper) shareButtonWrapper.style.display = 'flex';
             const footerDiv = document.getElementById('reportFooter');
             if(footerDiv) footerDiv.textContent = '';
        }

        function updateTableFooter(monthKey, startDay, endDay) {
            const tableFooter = document.getElementById('attendanceTableFooter');
            if (!tableFooter) return;

            if (currentUser && monthKey && data[currentUser]?.months?.[monthKey]?.days) {
                tableFooter.style.display = 'table-footer-group';
                const totals = calculatePeriodTotals(currentUser, monthKey, startDay, endDay);
                document.getElementById('totalOvertime').textContent = totals.totalOvertimeHours.toFixed(2);
                document.getElementById('totalRent').textContent = totals.totalRent.toFixed(2);
                document.getElementById('totalFood').textContent = totals.totalFood.toFixed(2);
                document.getElementById('totalReceived').textContent = totals.totalDailyReceived.toFixed(2);
                document.getElementById('totalStatus').textContent = totals.totalPresent.toFixed(2) + ' P';
                const totalLabelCell = document.querySelector('#tableFooterRow td[data-translate-key="totalLabel"]');
                if(totalLabelCell) totalLabelCell.textContent = translate('totalLabel');
            } else {
                tableFooter.style.display = 'none';
            }
        }











function renderTable() {
    const container = document.getElementById("tableContainer");
    if (!currentUser || !currentlyViewedPeriod) { container.innerHTML = ""; return; }
    
    const userData = data[currentUser];
    const [monthKey, periodPart] = currentlyViewedPeriod.split('_');
    const [year, monthIndexBase1] = monthKey.split('-').map(Number);
    const daysInSelectedMonth = getDaysInMonth(year, monthIndexBase1 - 1);
    
    // ‡§°‡•á‡§ü‡§æ ‡§ö‡•á‡§ï ‡§î‡§∞ ‡§á‡§®‡§ø‡§∂‡§ø‡§Ø‡§≤‡§æ‡§á‡§ú‡§º‡•á‡§∂‡§®
    if (!userData.months[monthKey]) userData.months[monthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
    let daysData = userData.months[monthKey].days;

    // ‡§Ö‡§ó‡§∞ ‡§¶‡§ø‡§® ‡§ï‡§Æ ‡§π‡•à‡§Ç ‡§§‡•ã ‡§î‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
    if (daysData.length < daysInSelectedMonth) {
        for(let i=daysData.length; i<daysInSelectedMonth; i++) {
            daysData.push({ date:`${i+1}/${monthIndexBase1}/${year}`, status:'', overtime:0, rent:0, food:0, received:0, notes:'', updated:'' });
        }
        saveData();
    }

    // ‡§π‡§æ‡§´ ‡§Æ‡§Ç‡§• ‡§Ø‡§æ ‡§´‡•Å‡§≤ ‡§Æ‡§Ç‡§• ‡§Æ‡•ã‡§° ‡§ï‡•Ä ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó
    let start = 0, end = daysInSelectedMonth - 1;
    if (calculationMode === 'halfMonth') {
        if (periodPart === '1') end = 14; else start = 15;
    }
    
    // ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•á‡§Ç‡§ú ‡§ö‡•á‡§ï
    end = Math.min(end, daysData.length - 1);

    let html = `<div class="table-responsive"><table><thead><tr>
                <th>${translate('dateHeaderTbl')}</th>
                <th>${translate('statusHeaderTbl')}</th>
                <th>${translate('otHeaderTbl')}</th>
                <th>${translate('rentHeaderTbl')}</th>
                <th>${translate('foodHeaderTbl')}</th>
                <th>${translate('receivedHeaderTbl')}</th>
                <th>${translate('notesHeaderTbl')}</th>
                <th>${translate('editedHeaderTbl')}</th>
                </tr></thead><tbody>`;

    const daysSlice = daysData.slice(start, end + 1);
    const todayDateString = getCurrentDateString();
    
    daysSlice.forEach((d, idx) => {
        const originalIndex = start + idx;
        const dateObj = new Date(year, monthIndexBase1-1, originalIndex+1);
        
        // ‡§¶‡§ø‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ (Mon, Tue...)
        let dayName = '';
        try {
             dayName = new Intl.DateTimeFormat(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { weekday: 'short' }).format(dateObj);
        } catch(e) { dayName = ''; }

        // Row Class (Sunday/Current Day)
        let rowClass = "";
        if(dateObj.getDay()===0) rowClass = "sunday-row";
        if(dateObj.getDay()===5) rowClass = "friday-row";
        
        // ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§Æ‡•à‡§ö ‡§ï‡§∞‡•á‡§Ç "D/M/YYYY"
        const dDateParts = (d.date || '').split('/');
        const generatedDateStr = `${dateObj.getDate()}/${dateObj.getMonth()+1}/${dateObj.getFullYear()}`;
        if(generatedDateStr === todayDateString) rowClass += " current-day-row";

        // RED ABSENT CHECK (‡§Ö‡§ó‡§∞ Status 'A' ‡§π‡•à ‡§§‡•ã ‡§≤‡§æ‡§≤ ‡§∞‡§Ç‡§ó)
        const statusClass = (d.status||'').toUpperCase() === 'A' ? 'status-cell-absent' : '';
        
        // Icons Logic: ‡§Ö‡§ó‡§∞ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§π‡•à ‡§§‡•ã 'input-has-value', ‡§®‡§π‡•Ä‡§Ç ‡§§‡•ã ‡§Ü‡§á‡§ï‡§® ‡§µ‡§æ‡§≤‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§∏
        const rentCls = Number(d.rent) ? 'input-has-value' : 'rent-cell';
        const foodCls = Number(d.food) ? 'input-has-value' : 'food-cell';
        const recCls = Number(d.received) ? 'input-has-value' : 'received-cell';

        // Edited Date display
        let editShowDate = '';
        let editShowTime = '';
        if (d.updated) {
            const upDate = new Date(d.updated);
            editShowDate = upDate.toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '-');
            editShowTime = upDate.toLocaleTimeString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {hour: '2-digit', minute: '2-digit', hourCycle: 'h23'});
        }

        html += `<tr class="${rowClass}">
            <td><span class="day-name-in-date-cell">${dayName}</span>${d.date}</td>
            
            <td class="${statusClass}">
                <input type="text" data-month="${monthKey}" data-index="${originalIndex}" data-field="status" value="${d.status||''}" autocomplete="off">
            </td>
            
            <td>
                <input type="number" step="any" data-month="${monthKey}" data-index="${originalIndex}" data-field="overtime" value="${Number(d.overtime)===0?'':d.overtime}" autocomplete="off">
            </td>
            
            <td class="${rentCls}">
                <input type="number" step="any" data-month="${monthKey}" data-index="${originalIndex}" data-field="rent" value="${Number(d.rent)===0?'':d.rent}" autocomplete="off">
            </td>
            
            <td class="${foodCls}">
                <input type="number" step="any" data-month="${monthKey}" data-index="${originalIndex}" data-field="food" value="${Number(d.food)===0?'':d.food}" autocomplete="off">
            </td>
            
            <td class="${recCls}">
                <input type="number" step="any" data-month="${monthKey}" data-index="${originalIndex}" data-field="received" value="${Number(d.received)===0?'':d.received}" autocomplete="off">
            </td>
            
          

<td class="notes-cell" onclick="openNotesModal('${monthKey}', ${originalIndex})">
    <span class="note-preview">${(d.notes||'')}</span>
</td>
            
            <td class="edited-datetime-cell">
                 <input type="text" class="edited-date-input" data-month="${monthKey}" data-index="${originalIndex}" data-field="updated_date" value="${editShowDate}" placeholder="DD-MM-YYYY">
                 <input type="text" class="edited-time-input" data-month="${monthKey}" data-index="${originalIndex}" data-field="updated_time" value="${editShowTime}" placeholder="HH:MM">
            </td>
        </tr>`;
    });

    html += `</tbody><tfoot id="attendanceTableFooter"><tr id="tableFooterRow">
             <td data-translate-key="totalLabel">Total</td>
             <td id="totalStatus"></td>
             <td id="totalOvertime"></td>
             <td id="totalRent"></td>
             <td id="totalFood"></td>
             <td id="totalReceived"></td>
             <td></td><td></td>
             </tr></tfoot></table></div>`;
    
    container.innerHTML = html;
    addTableEventListeners(); // Listener ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ú‡•ã‡§°‡§º‡§®‡§æ ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à
    updateTableFooter(monthKey, start, end + 1);
    renderPreviousBalancePayments();
    
    // ‡§Ö‡§ó‡§∞ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§π‡•à ‡§§‡•ã ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ê‡§° ‡§ï‡§∞‡•á‡§Ç (Visual fix)
    container.querySelectorAll('td.rent-cell input, td.food-cell input, td.received-cell input').forEach(input => {
       const td = input.parentElement;
       if (input.value.trim() !== '') td.classList.add('input-has-value'); else td.classList.remove('input-has-value');
    });

    applyTranslationsToUI();
}




        function addTableEventListeners() {
            const table = document.querySelector('#tableContainer table');
              if (!table) { return; }
              table.removeEventListener('input', handleTableInput);
              table.addEventListener('input', handleTableInput);
        }





        
function handleTableInput(event) {
     const target = event.target;
     if (target.tagName === 'INPUT' && target.dataset.field && target.parentElement.tagName === 'TD') {
         const { month, index, field } = target.dataset; 
         let valueToStore; 
         let rawValue = target.value;
         const dayIndex = parseInt(index);

         // --- 1. 'A' (Absent) Logic ---
         if (field === 'status') {
              valueToStore = rawValue.trim().toUpperCase();
              const td = target.parentElement;
              
              // ‡§Ö‡§ó‡§∞ 'A' ‡§π‡•à ‡§§‡•ã ‡§≤‡§æ‡§≤ ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç, ‡§®‡§π‡•Ä‡§Ç ‡§§‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç
              if (valueToStore === 'A') {
                  td.classList.add('status-cell-absent');
              } else {
                  td.classList.remove('status-cell-absent');
              }
              
              // ‡§µ‡•à‡§≤‡§ø‡§°‡•á‡§∂‡§® (Validation)
              const isValidStatus = valueToStore === '' || /^[PHAL]$/.test(valueToStore) || /^\d+P$/.test(valueToStore);
              if (!isValidStatus && valueToStore !== '') {
                   // ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§á‡§®‡§™‡•Å‡§ü ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (optional)
                   // target.value = ...; 
              }
              update(month, dayIndex, field, valueToStore);
         
         } else if (['rent', 'food', 'received', 'overtime'].includes(field)) {
             // --- 2. Icon Hide/Show Logic ---
             const td = target.parentElement;
             if (rawValue.trim() !== '') td.classList.add('input-has-value'); 
             else td.classList.remove('input-has-value');
             
             if (rawValue.trim() === '' || rawValue.trim() === '-') valueToStore = 0;
             else {
                 valueToStore = parseFloat(rawValue);
                 if (isNaN(valueToStore)) valueToStore = 0;
                 else if (valueToStore < 0) valueToStore = 0;
             }
             update(month, dayIndex, field, valueToStore);
         
         } else if (field === 'updated_date' || field === 'updated_time') {
             valueToStore = rawValue.trim(); 
             update(month, dayIndex, field, valueToStore);
         }
     }
}





        function update(month, i, field, value) {
            if (!currentUser || !data[currentUser]?.months?.[month]?.days?.[i]) { return; }
            const day = data[currentUser].months[month].days[i];

            if (field === 'updated_date' || field === 'updated_time') {
                const dateInput = document.querySelector(`input[data-month="${month}"][data-index="${i}"][data-field="updated_date"]`);
                const timeInput = document.querySelector(`input[data-month="${month}"][data-index="${i}"][data-field="updated_time"]`);
                let dateStr = dateInput.value.trim(); let timeStr = timeInput.value.trim();

                const datePattern = /^\d{1,2}-\d{1,2}-\d{4}$/; const timePattern = /^\d{1,2}:\d{1,2}$/;
                
                if (!dateStr && !timeStr) {
                    if (day.updated) { 
                        day.updated = ''; 
                        saveData(); 
                        scheduleSummaryUpdate(); 
                    }
                    return;
                }
                
                if (dateStr && timeStr && datePattern.test(dateStr) && timePattern.test(timeStr)) {
                    const dateParts = dateStr.split('-'); const timeParts = timeStr.split(':');
                    if (dateParts.length === 3 && timeParts.length === 2) {
                        const dayParsed = parseInt(dateParts[0], 10); const monthParsed = parseInt(dateParts[1], 10);
                        const year = parseInt(dateParts[2], 10); const hours = parseInt(timeParts[0], 10);
                        const minutes = parseInt(timeParts[1], 10);
                        if (year >= 1900 && year <= 2100 && monthParsed >= 1 && monthParsed <= 12 &&
                            dayParsed >= 1 && dayParsed <= getDaysInMonth(year, monthParsed -1) &&
                            hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                            const parsedDate = new Date(year, monthParsed - 1, dayParsed, hours, minutes);
                            if (!isNaN(parsedDate.getTime())) {
                                const oldUpdatedValue = day.updated; 
                                day.updated = parsedDate.toISOString();
                                if (oldUpdatedValue !== day.updated) {
                                    saveData();
                                    scheduleSummaryUpdate();
                                }
                            }
                        }
                    }
                }
                return;
            }

            const currentValueInData = day[field]; let valueChanged = false;
            if (typeof value === 'number') {
                valueChanged = Math.abs(value - (Number(currentValueInData) || 0)) > 0.0001;
            } else {
                valueChanged = String(value) !== String(currentValueInData || '');
            }

            if (valueChanged) {
                day[field] = value;
                day.updated = new Date().toISOString();
                const dateInputElement = document.querySelector(`input[data-month="${month}"][data-index="${i}"][data-field="updated_date"]`);
                const timeInputElement = document.querySelector(`input[data-month="${month}"][data-index="${i}"][data-field="updated_time"]`);
                if (dateInputElement && timeInputElement) {
                    const d = new Date(day.updated);
                    dateInputElement.value = d.toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '-');
                    timeInputElement.value = d.toLocaleTimeString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {hour: '2-digit', minute: '2-digit', hourCycle: 'h23'});
                }
                saveData();
                scheduleSummaryUpdate();
            }
        }
        
        // --- NEW/REFACTORED: Function to calculate all summary data (logic only) ---
        function calculateSummary(userName, period) {
            if (!userName || !period || !data[userName]) return null;

            const [monthKey, periodPart] = period.split('_');
            const userData = data[userName];
            const currentMonthData = userData.months?.[monthKey];
            if (!currentMonthData) return null;

            let periodStartDayIndex = 0;
            let periodEndDayIndexExclusive = 31;
            let currentPeriodPrevBalPaymentsTotalInCents = toCents((currentMonthData.previousBalancePayments || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0));
            
            if (calculationMode === 'halfMonth') {
                if (periodPart === '1') {
                    periodEndDayIndexExclusive = 15;
                    currentPeriodPrevBalPaymentsTotalInCents = toCents((currentMonthData.previousBalancePayments || [])
                        .filter(p => new Date(p.date).getDate() <= 15)
                        .reduce((sum, p) => sum + (Number(p.amount) || 0), 0));
                } else { // periodPart === '2'
                    periodStartDayIndex = 15;
                    currentPeriodPrevBalPaymentsTotalInCents = toCents((currentMonthData.previousBalancePayments || [])
                        .filter(p => new Date(p.date).getDate() > 15)
                        .reduce((sum, p) => sum + (Number(p.amount) || 0), 0));
                }
            }

            const currentUserPeriodTotals = calculatePeriodTotals(userName, monthKey, periodStartDayIndex, periodEndDayIndexExclusive);
            const { totalPresent, totalOvertimeHours, totalRent, totalFood, totalDailyReceived, periodGross } = currentUserPeriodTotals;
            
            const periodGrossInCents = toCents(periodGross);
            const currentPeriodCarriedOverBalanceInCents = toCents(currentMonthData.carriedOverBalance);
            const totalDailyReceivedInCents = toCents(totalDailyReceived);

            const finalBalanceForPeriodInCents = (periodGrossInCents + currentPeriodCarriedOverBalanceInCents) - totalDailyReceivedInCents - currentPeriodPrevBalPaymentsTotalInCents;
            
            return {
                totalPresent: totalPresent,
                totalOvertimeHours: totalOvertimeHours,
                totalRent: totalRent,
                totalFood: totalFood,
                periodGross: periodGross,
                currentPeriodCarriedOverBalance: fromCents(currentPeriodCarriedOverBalanceInCents),
                totalDailyReceived: totalDailyReceived,
                totalReceivedPrevBalance: fromCents(currentPeriodPrevBalPaymentsTotalInCents),
                finalBalanceForPeriod: fromCents(finalBalanceForPeriodInCents),
            };
        }





function showSummary() {
    const div = document.getElementById("summarySection");
    if (!currentUser || !currentlyViewedPeriod) { div.innerHTML = ""; return; }

    // --- 1. ‡§∏‡§æ‡§∞‡§æ ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§ú‡•ã‡§°‡§º‡§®‡§æ (Calculation) ---
    const [mk, part] = currentlyViewedPeriod.split('_');
    const [y, m] = mk.split('-').map(Number);
    const dim = new Date(y, m, 0).getDate();
    
    // ‡§´‡•Å‡§≤ ‡§Æ‡§Ç‡§• ‡§Ø‡§æ ‡§π‡§æ‡§´ ‡§Æ‡§Ç‡§• ‡§ö‡•á‡§ï ‡§ï‡§∞‡§®‡§æ
    let start=0, end=dim;
    if(calculationMode === 'halfMonth') { if(part === '1') end=15; else start=15; }
    
    const totals = calculatePeriodTotals(currentUser, mk, start, end);
    const mData = data[currentUser].months[mk];
    
    // ‡§™‡§ø‡§õ‡§≤‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (Previous Balance Payment)
    let prevPay = 0;
    (mData.previousBalancePayments||[]).forEach(p => prevPay += Number(p.amount)||0);

    // ‡§∞‡•á‡§ü ‡§î‡§∞ ‡§∏‡•à‡§≤‡§∞‡•Ä
    const rate = Number(data[currentUser].rate)||0;
    const otRate = Number(data[currentUser].overtimeRate)||8;
    const salary = totals.totalPresent * rate;
    const otAmt = (rate>0 && otRate>0) ? (totals.totalOvertimeHours * rate)/otRate : 0;
    const prevBal = mData.carriedOverBalance || 0;

    // ‡§´‡§æ‡§á‡§®‡§≤ ‡§ú‡•ã‡§°‡§º-‡§ò‡§ü‡§æ‡§®‡§æ
    const totalCredit = salary + otAmt + totals.totalRent + totals.totalFood + prevBal;
    const totalDebit = totals.totalDailyReceived + prevPay;
    const netBalance = totalCredit - totalDebit;

    // --- 2. HTML ‡§¨‡§®‡§æ‡§®‡§æ (Bill Layout) ---
    div.innerHTML = `
    <div class="bill-container">
        
        <!-- ‡§¨‡§æ‡§Ø‡•Ä‡§Ç ‡§§‡§∞‡§´: ‡§ï‡§Æ‡§æ‡§à (Credits) -->
        <div class="bill-col">
            <div class="bill-header text-green">‚ûï CREDITS (‡§ú‡§Æ‡§æ)</div>
            
            <div class="bill-row">
                <span>Attendance (${totals.totalPresent} days):</span> 
                <span>${salary.toFixed(2)}</span>
            </div>
            <div class="bill-row">
                <span>Overtime (${totals.totalOvertimeHours} hrs):</span> 
                <span>${otAmt.toFixed(2)}</span>
            </div>
            <div class="bill-row">
                <span>Rent (Add):</span> 
                <span>${totals.totalRent.toFixed(2)}</span>
            </div>
            <div class="bill-row">
                <span>Food (Add):</span> 
                <span>${totals.totalFood.toFixed(2)}</span>
            </div>
            <div class="bill-row">
                <span>Prev. Balance:</span> 
                <span>${prevBal.toFixed(2)}</span>
            </div>

            <div class="bill-row total-row">
                <span>TOTAL EARNINGS:</span>
                <span class="text-green">‚Çπ ${totalCredit.toFixed(2)}</span>
            </div>
        </div>

        <!-- ‡§¶‡§æ‡§à‡§Ç ‡§§‡§∞‡§´: ‡§ï‡§ü‡•å‡§§‡•Ä (Debits) -->
        <div class="bill-col">
            <div class="bill-header text-red">‚ûñ DEBITS (‡§®‡§æ‡§Æ)</div>
            
            <div class="bill-row">
                <span>Received (Daily):</span> 
                <span>${totals.totalDailyReceived.toFixed(2)}</span>
            </div>
            <div class="bill-row">
                <span>Paid (Prev Bal):</span> 
                <span>${prevPay.toFixed(2)}</span>
            </div>
            
            <!-- ‡§ñ‡§æ‡§≤‡•Ä ‡§ú‡§ó‡§π ‡§≠‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è (‡§§‡§æ‡§ï‡§ø ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¨‡§∞‡§æ‡§¨‡§∞ ‡§¶‡§ø‡§ñ‡•á‡§Ç) -->
            <div class="bill-row" style="border:none; opacity:0;"><br></div>
            <div class="bill-row" style="border:none; opacity:0;"><br></div>
            <div class="bill-row" style="border:none; opacity:0;"><br></div>

            <div class="bill-row total-row">
                <span>TOTAL RECEIVED:</span>
                <span class="text-red">‚Çπ ${totalDebit.toFixed(2)}</span>
            </div>
        </div>

        <!-- ‡§®‡•Ä‡§ö‡•á: ‡§´‡§æ‡§á‡§®‡§≤ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ -->
        <div class="bill-footer">
            <span>NET BALANCE (‡§∂‡•á‡§∑):</span>
            <span>‚Çπ ${netBalance.toFixed(2)}</span>
        </div>
    </div>`;
}






async function shareReport() {
    const reportArea = document.getElementById('reportArea');
    const monthlySummaryDiv = document.getElementById('summarySection');
    const tableContainer = document.getElementById('tableContainer');
    const otherUserSelect = document.getElementById('otherUserForReport');
    const selectedOtherUserName = otherUserSelect.value;

    // ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡•á‡§ñ‡•á‡§Ç
    const includeNotes = document.getElementById('includeNotesInShare').checked;
    const includeEdited = document.getElementById('includeEditedInShare').checked;

    if (monthlySummaryDiv.style.display !== 'block' || monthlySummaryDiv.innerText.trim()==="" || monthlySummaryDiv.innerText.includes(translate('alertSelectUserMonth')) || !tableContainer || tableContainer.innerHTML.trim() === "") {
            alert(translate('alertGenerateReportFirst')); return;
    }
    if (!currentUser || !currentlyViewedPeriod || !data[currentUser]?.months?.[currentlyViewedPeriod.split('_')[0]]) {
            alert(translate('alertCannotGenerateImage')); return;
    }

    // 1. ‡§ú‡§ø‡§®‡•ç‡§π‡•á‡§Ç ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§õ‡§ø‡§™‡§æ‡§®‡§æ ‡§π‡•à (Buttons etc.)
    const elementsToHide = [
        document.getElementById('addPaymentForm'), document.getElementById('quickMonthChangeBtn'),
        document.getElementById('dataManagementButtons'), document.getElementById('userRate'),
        document.getElementById('userOvertimeRate'), document.getElementById('manualCarriedOverBalance'),
        document.getElementById('otherUserForReport'), document.getElementById('viewOverallReportBtn'),
        document.getElementById('overallSummarySection'),
        ...(document.getElementById('previousBalancePaymentsSection')?.querySelectorAll('.delete-payment-btn') || [])
    ].filter(el => el != null);
    document.querySelectorAll('#userQuickControls label').forEach(label => elementsToHide.push(label));

    // UI ‡§õ‡§ø‡§™‡§æ‡§®‡§æ
    const originalDisplays = elementsToHide.map(el => el.style.display);
    elementsToHide.forEach(el => { el.style.display = 'none'; });

    // 2. ‡§ï‡•â‡§≤‡§Æ‡•ç‡§∏ ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ‡§®‡•á ‡§ï‡§æ ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§≤‡•â‡§ú‡§ø‡§ï (Notes & Edited)
    const hiddenColumns = [];
    
    // Notes Column (7th child) - ‡§Ö‡§ó‡§∞ ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Ö‡§®‡§ö‡•á‡§ï ‡§π‡•à
    if (!includeNotes) {
        document.querySelectorAll('#tableContainer tr > *:nth-child(7)').forEach(el => {
            hiddenColumns.push({ element: el, originalDisplay: el.style.display });
            el.style.setProperty('display', 'none', 'important'); // ‡§ú‡§¨‡§∞‡§¶‡§∏‡•ç‡§§‡•Ä ‡§õ‡§ø‡§™‡§æ‡§è‡§Ç
        });
    }

    // Edited Column (8th child) - ‡§Ö‡§ó‡§∞ ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Ö‡§®‡§ö‡•á‡§ï ‡§π‡•à
    if (!includeEdited) {
        document.querySelectorAll('#tableContainer tr > *:nth-child(8)').forEach(el => {
            hiddenColumns.push({ element: el, originalDisplay: el.style.display });
            el.style.setProperty('display', 'none', 'important'); // ‡§ú‡§¨‡§∞‡§¶‡§∏‡•ç‡§§‡•Ä ‡§õ‡§ø‡§™‡§æ‡§è‡§Ç
        });
    }

    // 3. ‡§á‡§®‡§™‡•Å‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§®‡§æ (‡§§‡§æ‡§ï‡§ø ‡§´‡•ã‡§ü‡•ã ‡§∏‡§æ‡§´ ‡§Ü‡§è)
    const elementsToReplace = [];
    document.querySelectorAll('#tableContainer tbody td input, #tableContainer tbody td .note-preview').forEach(element => {
        const td = element.closest('td'); if (!td) return;
        
        // ‡§Ö‡§ó‡§∞ ‡§ï‡•â‡§≤‡§Æ ‡§õ‡§ø‡§™‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à (display: none), ‡§§‡•ã ‡§â‡§∏‡•á ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§® ‡§ï‡§∞‡•á‡§Ç
        if(window.getComputedStyle(td).display === 'none') return;

        const span = document.createElement('span'); let displayValue = "";
        if (element.tagName === 'INPUT') {
            const field = element.dataset.field; displayValue = element.value;
            if (['overtime', 'rent', 'food', 'received'].includes(field)) {
                const num = parseFloat(displayValue);
                if (isNaN(num) || num === 0) displayValue = '';
                else { let precision = (field === 'overtime') ? 2 : 2; displayValue = String(Number(num.toFixed(precision))); if (displayValue === "0") displayValue = ""; }
            } else if (field === 'status') displayValue = displayValue.trim().toUpperCase();
            else if (field === 'updated_date' || field === 'updated_time') {
                if (td.classList.contains('edited-datetime-cell')) { span.style.display = 'block'; span.style.textAlign = 'center'; span.style.fontSize = '0.80em';}
            }
        } else if (element.classList.contains('note-preview')) {
            displayValue = element.textContent; span.style.display = 'inline-block'; span.style.fontSize = '0.9em';
            span.style.color = window.getComputedStyle(element).color; span.style.textAlign = 'left';
            span.style.paddingLeft = '5px'; span.style.width = '100%'; span.style.overflow = 'hidden';
            span.style.textOverflow = 'ellipsis'; span.style.whiteSpace = 'nowrap';
        }
        span.textContent = displayValue; const compStyle = window.getComputedStyle(element);
            if (element.tagName === 'INPUT' && !td.classList.contains('edited-datetime-cell')) {
            span.style.cssText += `display:inline-block;width:100%;box-sizing:border-box;padding:${compStyle.padding};text-align:${td.offsetWidth<=35?'center':compStyle.textAlign};vertical-align:middle;line-height:${compStyle.lineHeight};font-size:${compStyle.fontSize};font-family:${compStyle.fontFamily};color:${compStyle.color};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background-color:transparent;border:none;`;
            td.style.verticalAlign='middle';
        }
        elementsToReplace.push({originalElement: element, parentTd: td, tempSpan: span});
        try { td.replaceChild(span, element); } catch(e) {console.warn("Error replacing element for html2canvas", e)}
    });

    await new Promise(r => setTimeout(r, 50));
    
    // ‡§´‡•Å‡§ü‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ‡§®‡§æ
    const footerDiv = document.getElementById('reportFooter');
    const [monthKey, periodPart] = currentlyViewedPeriod.split('_');
    const [year, monthNum] = monthKey.split('-').map(Number);
    const monthName = new Intl.DateTimeFormat(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { month: 'long' }).format(new Date(year, monthNum - 1, 1));
    let periodTitle = `${monthName} ${year}`;
    if (calculationMode === 'halfMonth') {
        periodTitle += ` (${periodPart === '1' ? '1-15' : '16-End'})`;
    }

    if(footerDiv){
        const now = new Date();
        const formatter = new Intl.DateTimeFormat(currentLanguage==='hi'?'hi-IN-u-nu-latn':'en-GB', {year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
        
        const currentSummary = calculateSummary(currentUser, currentlyViewedPeriod);
        let mainBalance = currentSummary ? currentSummary.finalBalanceForPeriod.toFixed(2) : "0.00";
        let otherUserBalanceString = "";

        if (selectedOtherUserName && data[selectedOtherUserName]) {
            const otherUserSummary = calculateSummary(selectedOtherUserName, currentlyViewedPeriod);
            if(otherUserSummary) {
                const otherUserFinalBalance = otherUserSummary.finalBalanceForPeriod;
                const combinedFinalBalance = fromCents(toCents(mainBalance) + toCents(otherUserFinalBalance));
                otherUserBalanceString = translate('footerIncludeOtherUserFinalBalance', {
                    otherUser: selectedOtherUserName,
                    otherUserFinalBalance: otherUserFinalBalance.toFixed(2),
                    combinedBalance: combinedFinalBalance.toFixed(2)
                });
                mainBalance = combinedFinalBalance.toFixed(2);
            }
        }

        footerDiv.textContent = translate('reportGeneratedOn',{
                user:currentUser, periodTitle: periodTitle,
                balance: mainBalance, dateTime:formatter.format(now),
                otherUserBalanceString: otherUserBalanceString
            });
            await new Promise(r => setTimeout(r, 50));
    }

    // 4. ‡§∞‡§ø‡§∏‡•ç‡§ü‡•ã‡§∞ (Restore) ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® - UI ‡§µ‡§æ‡§™‡§∏ ‡§≤‡§æ‡§®‡§æ
    const restoreElements = () => {
        elementsToHide.forEach((el, i) => { if(el) el.style.display = originalDisplays[i]; });
        
        // ‡§ï‡•â‡§≤‡§Æ‡•ç‡§∏ ‡§µ‡§æ‡§™‡§∏ ‡§≤‡§æ‡§è‡§Ç
        hiddenColumns.forEach(item => {
            item.element.style.display = item.originalDisplay;
        });

        // ‡§á‡§®‡§™‡•Å‡§ü‡•ç‡§∏ ‡§µ‡§æ‡§™‡§∏ ‡§≤‡§æ‡§è‡§Ç
        elementsToReplace.forEach(({originalElement, parentTd, tempSpan}) => {
                if(parentTd && tempSpan && parentTd.contains(tempSpan)){
                try { parentTd.replaceChild(originalElement, tempSpan); } catch(e){}
                }
                if(parentTd) parentTd.style.verticalAlign = '';
        });
    };

    // 5. ‡§á‡§Æ‡•á‡§ú ‡§¨‡§®‡§æ‡§®‡§æ
    try {
        const canvas = await html2canvas(reportArea, {
            scale: 2, logging: false, useCORS: true,
            backgroundColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff',
        });
        if(!canvas) throw new Error("Canvas creation failed.");
        canvas.toBlob(async blob => {
            restoreElements(); if(!blob){ alert(translate('alertCouldNotGenerateImage')); return; }
            const file = new File([blob], `attendance_report_${currentUser}_${currentlyViewedPeriod}.png`, {type:'image/png'});
            const shareTitle = translate('reportFor', { user: currentUser, title: periodTitle });
            
            const finalSummaryForShare = calculateSummary(currentUser, currentlyViewedPeriod);
            let finalShareText = shareTitle;
            if(finalSummaryForShare){
                finalShareText += `\n${translate('finalBalanceDueForPeriod', {amount: finalSummaryForShare.finalBalanceForPeriod.toFixed(2)})}`;
            }
            
            if (selectedOtherUserName && data[selectedOtherUserName]) {
                const otherUserSummaryForShare = calculateSummary(selectedOtherUserName, currentlyViewedPeriod);
                if (finalSummaryForShare && otherUserSummaryForShare) {
                    const combinedFinal = fromCents(toCents(finalSummaryForShare.finalBalanceForPeriod) + toCents(otherUserSummaryForShare.finalBalanceForPeriod));
                    finalShareText = `${shareTitle}\n${translate('combinedFinalBalance', { currentUser: currentUser, otherUser: selectedOtherUserName, amount: combinedFinal.toFixed(2) })}`;
                }
            }

            if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
                try {
                    await navigator.share({ files: [file], title: shareTitle, text: finalShareText });
                } catch(err) {
                    if(err.name !== 'AbortError'){ alert(translate('alertWebShareFailed')); downloadBlob(blob, file.name); }
                }
            } else { downloadBlob(blob, file.name); alert(translate('alertImageDownloaded')); }
        }, 'image/png', 0.9);
    } catch(err) { restoreElements(); alert(`${translate('alertCouldNotGenerateImage')}\nError: ${err.message}`); }
}





        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a);
            a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }




        function getCurrentPeriod() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            if (calculationMode === 'fullMonth') {
                return `${year}-${month}`;
            } else {
                const day = today.getDate();
                const periodPart = day <= 15 ? '1' : '2';
                return `${year}-${month}_${periodPart}`;
            }
        }










        function toggleDataMenu() {
            const menu = document.getElementById('dataManagementButtons');
            const archiveBtn = document.getElementById('archiveUserBtn');
            const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
            if (menu.style.display === 'none' || menu.style.display === "") {
                menu.style.display = 'flex';
                if (archiveBtn) {
                    if (currentUser && data[currentUser]) {
                         archiveBtn.style.display = 'inline-block'; applyTranslationsToUI();
                    } else archiveBtn.style.display = 'none';
                }
                if (toggleArchivedBtn) {
                    const hasArchived = Object.values(data).some(u => u.isActive === false);
                    toggleArchivedBtn.style.display = hasArchived || showArchivedUsers ? 'inline-block' : 'none';
                    applyTranslationsToUI();
                }
            } else menu.style.display = 'none';
        }

        function clearAllCarriedBalances() {
            if (!confirm(translate('confirmClearBalances'))) {
                return;
            }
            if (!data || Object.keys(data).length === 0) {
                return;
            }
            for (const userName in data) {
                if (data[userName].months) {
                    for (const monthKey in data[userName].months) {
                        if (data[userName].months[monthKey]) {
                            data[userName].months[monthKey].carriedOverBalance = 0;
                        }
                    }
                }
            }
            saveData();
            alert(translate('alertBalancesCleared'));
            fullRender();
        }

        function clearAllData() {
            if(confirm(translate('confirmClearData'))){
                if(renderTimeout) clearTimeout(renderTimeout);
                localStorage.removeItem('attendanceData'); localStorage.removeItem('lastSelectedUser');
                localStorage.removeItem('calculationMode');
                data = {}; currentUser = null; currentlyViewedPeriod = null; 
                calculationMode = 'fullMonth';
                setModeIcon();
                importDataBuffer = null; showArchivedUsers = false;
                fullRender();
                document.getElementById("newUserName").value = "";
                document.getElementById("userTabs").innerHTML = ""; document.getElementById("userTabs").style.display = 'none';
                populateOtherUserDropdown();
                setDarkMode(localStorage.getItem('darkMode') === 'enabled');
                currentLanguage = localStorage.getItem('appLanguage') || 'hi';
                document.documentElement.lang = currentLanguage; applyTranslationsToUI();
                alert(translate('alertDataCleared'));
                const menu = document.getElementById('dataManagementButtons'); if(menu) menu.style.display = 'none';
            }
        }

        function exportData() {
            try{
                 const exportObj = {
                     attendanceData: data,
                     exportDate: new Date().toISOString(),
                     appVersion: "3.3.0", // Version updated
                     language: currentLanguage,
                     darkMode: localStorage.getItem('darkMode'),
                     showArchivedUsers: showArchivedUsers,
                     calculationMode: calculationMode
                 };
                downloadBlob(new Blob([JSON.stringify(exportObj,null,2)],{type:'application/json'}),`attendance_data_${new Date().toISOString().slice(0,10)}.json`);
                alert(translate('alertDataExported'));
                const menu = document.getElementById('dataManagementButtons'); if(menu) menu.style.display = 'none';
            } catch(e){ alert(translate('alertExportFailed',{error:e.message})); }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0]; if(!file){ alert(translate('alertNoFileSelected')); return; }
            if(file.type !== 'application/json' && !file.name.toLowerCase().endsWith('.json')){
                alert(translate('alertSelectJsonFile')); event.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const parsedData = JSON.parse(e.target.result);
                    if(!parsedData || typeof parsedData !== 'object' || !parsedData.attendanceData || typeof parsedData.attendanceData !== 'object') {
                        throw new Error(translate('alertInvalidImportFormat'));
                    }
                    if (parsedData.calculationMode) {
                        localStorage.setItem('calculationMode', parsedData.calculationMode);
                        calculationMode = parsedData.calculationMode;
                        setModeIcon();
                    }
                    importDataBuffer = parsedData.attendanceData; 
                    showImportPreview(importDataBuffer);
                } catch(err) { alert(translate('alertImportProcessingError',{error: err.message}));
                } finally { event.target.value = ''; }
            };
            reader.onerror = () => { alert(translate('alertFileReadError')); event.target.value = ''; };
            reader.readAsText(file);
        }

        function showImportPreview(importData) {
             const modal = document.getElementById('importPreviewModal');
             const content = document.getElementById('importPreviewContent');
             const footer = modal.querySelector('.modal-footer');
             const count = importData && typeof importData === 'object' ? Object.keys(importData).length : 0;
            if (count === 0) {
                content.innerHTML = `<p>${translate('alertNoImportData')}</p>`; footer.style.display = 'none';
            } else {
                footer.style.display = 'flex';
                let html = `<div class="preview-section"><div class="preview-header">${translate('importPreviewTitle')}:</div>
                                <p>${translate('importContainsUsers', { count })}</p></div><div class="user-preview">`;
                const userNames = Object.keys(importData).slice(0, 5);
                userNames.forEach(name => {
                    const u = importData[name];
                    const statusText = (u && u.isActive === false) ? ` (${translate('archiveUser')})` : '';
                    const rate = (u && u.rate !== undefined) ? u.rate : 0;
                    const otRate = (u && u.overtimeRate !== undefined) ? u.overtimeRate : 8;
                    const monthCount = (u && u.months) ? Object.keys(u.months).length : 0;
                    html += `<p><strong>${name}</strong>${statusText} - ${translate('rateLabel')} ${rate}, ${translate('overtimeRateLabel')} ${otRate}, Months: ${monthCount}</p>`;
                });
                if(count > 5) html += `<p>${translate('andMoreUsers',{count: count - 5})}</p>`;
                html += `</div><div class="preview-section"><div class="preview-header">${translate('currentData')}</div>
                            <p>${translate('youHaveUsers',{count:Object.keys(data||{}).length})}</p></div>
                        <div class="import-option"><p><strong>${translate('importChooseOption')}</strong></p>
                            <ul><li>${translate('importOptionMerge')}</li><li>${translate('importOptionReplace')}</li></ul></div>`;
                content.innerHTML = html;
            }
            modal.style.display='block'; applyTranslationsToUI();
            const menu = document.getElementById('dataManagementButtons'); if(menu) menu.style.display = 'none';
        }

        function confirmImport(mode) {
            if(!importDataBuffer){ alert(translate('alertNoImportData')); closeImportModal(); return; }
            try {
                if(mode === 'replace'){
                    data = JSON.parse(JSON.stringify(importDataBuffer));
                    localStorage.removeItem('lastSelectedUser');
                } else if(mode === 'merge'){
                    for(const name in importDataBuffer){
                        const importedUser = importDataBuffer[name];
                        if (importedUser && typeof importedUser === 'object') {
                            if (data[name]) {
                                data[name].rate = importedUser.rate ?? data[name].rate;
                                data[name].overtimeRate = importedUser.overtimeRate ?? data[name].overtimeRate;
                                data[name].isActive = importedUser.isActive ?? data[name].isActive;
                                data[name].months = data[name].months || {};
                                if (importedUser.months && typeof importedUser.months === 'object') {
                                    for(const mKey in importedUser.months){
                                        if(importedUser.months[mKey]) {
                                            data[name].months[mKey] = JSON.parse(JSON.stringify(importedUser.months[mKey]));
                                        }
                                    }
                                }
                            } else {
                                data[name] = JSON.parse(JSON.stringify(importedUser));
                            }
                        }
                    }
                }
                saveData();
                loadData();
                closeImportModal();
                alert(translate('alertDataImported',{mode: mode==='replace' ? translate('replaceAllData') : translate('mergeData')}));
            } catch(e){ alert(translate('alertImportFailed',{error: e.message})); closeImportModal();
            } finally { importDataBuffer = null; }
        }

        function closeImportModal() {
             document.getElementById('importPreviewModal').style.display = 'none';
             importDataBuffer = null;
        }

        function openNotesModal(monthKey, dayIndex) {
            if (!currentUser || !data[currentUser]?.months?.[monthKey]?.days?.[dayIndex]) {
                console.error("Cannot open notes modal: Invalid data path."); return;
            }
            const dayData = data[currentUser].months[monthKey].days[dayIndex];
            const modal = document.getElementById('notesModal');
            const textarea = document.getElementById('modalNoteTextarea');
            const monthKeyInput = document.getElementById('modalNoteMonthKey');
            const dayIndexInput = document.getElementById('modalNoteDayIndex');
            textarea.value = dayData.notes || '';
            monthKeyInput.value = monthKey;
            dayIndexInput.value = dayIndex;
            const modalTitle = modal.querySelector('.modal-title');
            const dateForTitle = dayData.date || `${dayIndex + 1}/${monthKey.split('-')[1]}`;
            modalTitle.dataset.translateKey = 'notesModalTitle';
            modalTitle.textContent = `${translate('notesModalTitle')} - ${dateForTitle}`;
            modal.style.display = 'block';
            textarea.focus();
            applyTranslationsToUI();
        }

        function closeNotesModal() {
            const modal = document.getElementById('notesModal');
            modal.style.display = 'none';
            document.getElementById('modalNoteTextarea').value = '';
            document.getElementById('modalNoteMonthKey').value = '';
            document.getElementById('modalNoteDayIndex').value = '';
        }

        function saveModalNote() {
            const textarea = document.getElementById('modalNoteTextarea');
            const monthKey = document.getElementById('modalNoteMonthKey').value;
            const dayIndex = parseInt(document.getElementById('modalNoteDayIndex').value, 10);
            if (!currentUser || !monthKey || isNaN(dayIndex) || !data[currentUser]?.months?.[monthKey]?.days?.[dayIndex]) {
                console.error("Cannot save note: Invalid data path or index.");
                alert("Error saving note."); closeNotesModal(); return;
            }
            const newNoteText = textarea.value.trim();
            const dayData = data[currentUser].months[monthKey].days[dayIndex];
            if ((dayData.notes || '') !== newNoteText) {
                dayData.notes = newNoteText;
                dayData.updated = new Date().toISOString();
                saveData();
                const notesCell = document.querySelector(`#tableContainer td.notes-cell[onclick="openNotesModal('${monthKey}', ${dayIndex})"]`);
                if (notesCell) {
                    const previewSpan = notesCell.querySelector('.note-preview');
                    if (previewSpan) {
                        previewSpan.textContent = (newNoteText || '').substring(0, 20) + ((newNoteText || '').length > 20 ? '...' : '');
                    }
                }
                const dateInputElement = document.querySelector(`input[data-month="${monthKey}"][data-index="${dayIndex}"][data-field="updated_date"]`);
                const timeInputElement = document.querySelector(`input[data-month="${monthKey}"][data-index="${dayIndex}"][data-field="updated_time"]`);
                if (dateInputElement && timeInputElement && dayData.updated) {
                    dateInputElement.value = new Date(dayData.updated).toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '-');
                    timeInputElement.value = new Date(dayData.updated).toLocaleTimeString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {hour: '2-digit', minute: '2-digit', hourCycle: 'h23'});
                }
                scheduleSummaryUpdate();
            }
            closeNotesModal();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
             const paymentDateInput = document.getElementById('paymentDate');
             if (paymentDateInput) {
                paymentDateInput.valueAsDate = new Date();
             }
             if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => console.log('SW registered: ', registration.scope))
                        .catch(registrationError => console.log('SW registration failed: ', registrationError));
                });
            }
        });
    </script>
</div>
</body>
    </html>
